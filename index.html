<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¨Ø§Ø²ÛŒ Ù¾Ø±Ø´ Ú¯Ø±Ø¨Ù‡ Ùˆ Ù…ÙˆØ´</title>
    <!-- Tone.js for simple sound effects -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <!-- Tailwind CSS CDN for base styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700;900&display=swap');
        
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: #dbeafe; 
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        #game-container {
            background-color: #ffffff;
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3); 
            padding: 20px;
            width: 100%;
            max-width: 600px;
            text-align: center;
            position: relative; 
        }

        #game-canvas {
            display: block;
            background: linear-gradient(to bottom, #d6f2ff 0%, #d6f2ff 82%, #443021 82%, #443021 100%);
            border: 4px solid #333;
            border-radius: 10px;
            margin-top: 15px;
            box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.4); 
            touch-action: none; 
        }

        .game-ui {
            padding: 10px 0;
            display: flex;
            justify-content: space-between; 
            align-items: center;
        }

        #score-display {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e3a8a;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.15); 
        }
        
        #high-score-display, #coin-display { 
            font-size: 1.1rem;
            font-weight: 700;
            color: #ef4444; 
            border: 2px solid #fca5a5;
            padding: 4px 8px;
            border-radius: 5px;
            background-color: #fee2e2;
            display: inline-block;
            margin: 0 5px;
        }

        .btn {
            padding: 10px 20px;
            font-size: 1.2rem;
            font-weight: 700;
            color: white;
            background-color: #f97316; 
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s;
            box-shadow: 0 8px 25px rgba(249, 115, 22, 0.6); 
            margin-top: 10px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn:hover {
            background-color: #ea580c;
            transform: translateY(-4px); 
            box-shadow: 0 10px 30px rgba(249, 115, 22, 0.8);
        }

        .btn:active {
            transform: translateY(-1px);
        }

        /* Modal styling for all overlay boxes */
        .modal-box {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85); 
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }

        .modal-content {
            background-color: #fff;
            padding: 30px 40px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.8); 
            max-width: 90%;
            transform: scale(1);
            animation: pop-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            max-height: 80vh;
            overflow-y: auto;
        }
        
        /* Make shop modal larger for two-column layout */
        #shop-box .modal-content {
            max-width: 950px; 
            width: 95%; 
        }

        .message-title {
            font-size: 2.2rem;
            color: #f97316;
            margin-bottom: 10px;
        }

        /* Admin specific styling */
        .admin-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            text-align: center;
            font-size: 1rem;
            transition: border-color 0.2s;
        }
        
        /* Shop Item Styling */
        .shop-item {
            border: 2px solid;
            padding: 15px;
            border-radius: 12px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .shop-item.selected {
            border-color: #3b82f6;
            background-color: #eff6ff;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
        }
        .shop-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

    </style>
</head>
<body>

<div id="game-container" class="relative">
    <h1 class="text-3xl font-bold text-gray-800 mb-2">Ù¾Ø±Ø´ Ú¯Ø±Ø¨Ù‡: ØªØ¹Ù‚ÛŒØ¨ Ùˆ Ú¯Ø±ÛŒØ² Ù…ÙˆØ´ ğŸ±ğŸ­</h1>
    
    <!-- User Status Bar (Shows the numeric ID) -->
    <div id="user-status" class="flex justify-between items-center text-xs text-gray-600 mb-2 p-1 bg-gray-50 rounded-lg border border-gray-100" style="display: none;">
        <span id="user-info-text" class="text-sm font-bold text-indigo-700"></span>
        <button id="sign-out-button" class="bg-red-500 text-white px-2 py-1 rounded-md hover:bg-red-600 transition duration-150 text-xs hidden">Ø®Ø±ÙˆØ¬</button>
    </div>

    <div class="game-ui">
        <div class="flex items-center">
            <div id="score-display">Ø§Ù…ØªÛŒØ§Ø²: 0</div>
        </div>
        <button id="shop-button" class="btn bg-blue-500 hover:bg-blue-600 shadow-blue-500/40 !text-sm !py-2 !px-4 !m-0">
            ÙØ±ÙˆØ´Ú¯Ø§Ù‡ ğŸ›ï¸
        </button>
    </div>
    
    <div class="flex justify-center mb-2">
        <div id="high-score-display">Ø¨Ù‡ØªØ±ÛŒÙ†: 0</div>
        <div id="coin-display">Ø³Ú©Ù‡ Ú¯Ø±Ø¨Ù‡: 0 ğŸ’°</div>
    </div>

    <canvas id="game-canvas"></canvas>

    <!-- 1. Game Over / Start Message Box -->
    <div id="message-box" class="modal-box" style="display: flex;">
        <div id="message-content" class="modal-content">
            <div id="loading-prompt">
                <h2 class="message-title text-4xl text-gray-800">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª...</h2>
                <p class="text-gray-600 mt-2">Ù„Ø·ÙØ§Ù‹ ØµØ¨Ø± Ú©Ù†ÛŒØ¯.</p>
            </div>
            
            <div id="start-prompt" class="cursor-pointer hover:scale-105 transform transition duration-200" style="display: none;">
                <div class="text-[4rem] mb-2">ğŸ¾</div>
                <h2 class="message-title !text-4xl text-gray-800">Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ§ÛŒØŸ Ø¨Ø²Ù† Ø¨Ø±ÛŒÙ…!</h2>
            </div>

            <div id="game-over-details" style="display: none;">
                <!-- Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ø²ÛŒ ØªÙ…Ø§Ù… Ø´Ø¯: Ø§ÛŒÙ†Ø¬Ø§ Ø¬Ù…Ù„Ù‡ Ø§Ù†Ú¯ÛŒØ²Ø´ÛŒ/Ø·Ø¹Ù†Ù‡â€ŒØ¢Ù…ÛŒØ² Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ -->
                <h2 id="message-title" class="message-title">Ø¨Ø§Ø²ÛŒ ØªÙ…Ø§Ù… Ø´Ø¯!</h2>
                <p id="message-text" class="message-text"></p>
                <!-- NEW: Sarcastic/Motivational message -->
                <p id="sarcastic-message" class="text-base text-gray-600 mt-3 italic font-medium"></p>
                <button id="restart-button" class="btn bg-green-500 hover:bg-green-600 shadow-green-500/40">Ø´Ø±ÙˆØ¹ Ù…Ø¬Ø¯Ø¯</button>
            </div>
        </div>
    </div>
    
    <!-- 2. Shop Modal Box -->
    <div id="shop-box" class="modal-box" style="display: none;">
        <div class="modal-content !p-5">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h2 class="text-3xl font-bold text-gray-800">ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ú¯Ø±Ø¨Ù‡ ğŸ›ï¸</h2>
                <button id="close-shop-button" class="text-gray-500 hover:text-gray-700 text-3xl font-light leading-none">
                    &times;
                </button>
            </div>
            
            <div class="mb-4">
                <div id="shop-coin-display" class="font-bold text-xl text-yellow-700 bg-yellow-100 p-2 rounded-lg">
                    Ø³Ú©Ù‡ Ú¯Ø±Ø¨Ù‡ Ø´Ù…Ø§: 0 ğŸ’°
                </div>
                <p class="text-sm text-gray-500 mt-1">Ø§Ù…ØªÛŒØ§Ø²Ù‡Ø§ÛŒ Ú©Ø³Ø¨â€ŒØ´Ø¯Ù‡ Ø¯Ø± Ø¨Ø§Ø²ÛŒ Ø¨Ù‡ Ø³Ú©Ù‡ ØªØ¨Ø¯ÛŒÙ„ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ (ÙÙ‚Ø· Ø¨Ø§ Ø´Ú©Ø³ØªÙ† Ø±Ú©ÙˆØ±Ø¯).</p>
            </div>
            
            <!-- Shop Sections Container: Flexbox for side-by-side columns -->
            <div class="flex flex-col lg:flex-row gap-6">

                <!-- SECTION 1: CAT PURCHASE (Ø®Ø±ÛŒØ¯ Ú¯Ø±Ø¨Ù‡ Ùˆ Ù¾ÙˆØ³ØªÙ‡â€ŒÙ‡Ø§) - Takes 2/3 width on large screens -->
                <div class="w-full lg:w-2/3 bg-indigo-50 p-5 rounded-xl border-t-4 border-indigo-500 shadow-md">
                    <h3 class="text-xl font-extrabold text-indigo-800 mb-4 border-b pb-2">
                        Ø¨Ø®Ø´ Û±: Ø®Ø±ÛŒØ¯ Ú¯Ø±Ø¨Ù‡ Ùˆ Ù¾ÙˆØ³ØªÙ‡â€ŒÙ‡Ø§ ğŸ¾
                    </h3>
                    <div id="shop-items-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Shop items will be rendered here -->
                    </div>
                </div>
                <!-- END SECTION 1 -->

                <!-- SECTION 2: COIN SALE (ÙØ±ÙˆØ´ Ø³Ú©Ù‡ Ú¯Ø±Ø¨Ù‡) - Takes 1/3 width on large screens -->
                <div class="w-full lg:w-1/3 bg-yellow-100 p-5 rounded-xl border-t-4 border-yellow-500 shadow-md flex flex-col justify-between">
                    <div>
                        <h3 class="text-xl font-extrabold text-yellow-800 mb-3 border-b pb-2">
                            Ø¨Ø®Ø´ Û²: ÙØ±ÙˆØ´ Ø³Ú©Ù‡ Ú¯Ø±Ø¨Ù‡ ğŸ’¸
                        </h3>
                        <p class="text-gray-700 mb-4 text-sm leading-relaxed">
                            Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø³Ú©Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø¶Ø§ÙÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ø¨ÙØ±ÙˆØ´ÛŒØ¯! Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ø§Ù‡Ù†Ú¯ÛŒ Ùˆ ØªØ¹ÛŒÛŒÙ† Ù‚ÛŒÙ…ØªØŒ Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ Ø²ÛŒØ± Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯. Ø¢ÛŒØ¯ÛŒ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø´Ù…Ø§ Ø¨Ø±Ø§ÛŒ ØªØ£ÛŒÛŒØ¯ Ø­Ø³Ø§Ø¨ØŒ <span id="tele-uid-display" class="font-mono text-xs font-semibold text-gray-900">...</span> Ø§Ø³Øª.
                        </p>
                    </div>
                    <!-- Ø¯Ú©Ù…Ù‡ Ù‡Ø¯Ø§ÛŒØª Ø¨Ù‡ ØªÙ„Ú¯Ø±Ø§Ù… -->
                    <a id="telegram-link" href="https://t.me/moshgorbeadmin" target="_blank"
                       class="inline-flex items-center justify-center w-full bg-cyan-600 text-white py-2.5 px-6 rounded-lg font-black text-base transition duration-300 transform hover:bg-cyan-700 hover:scale-[1.02] shadow-lg focus:outline-none focus:ring-4 focus:ring-cyan-300 mt-4">
                        ÙØ±ÙˆØ´ Ø³Ú©Ù‡ Ùˆ ØªÙ…Ø§Ø³ Ø¨Ø§ Ø§Ø¯Ù…ÛŒÙ†
                        <!-- Ø¢ÛŒÚ©ÙˆÙ† ØªÙ„Ú¯Ø±Ø§Ù… (inline SVG for simplicity) -->
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M19.9 5.09a.57.57 0 00-.7-.1l-16.5 6.3a.57.57 0 00.08 1.05l4.6 1.48 10.33-6.57a.1.1 0 01.12.02l-8.52 7.72-.1 3.52c0 .24.18.44.42.48l1.7-.13c.12-.01.23-.08.28-.19l2.7-2.6 4.7 3.5a.57.57 0 00.4.15.58.58 0 00.37-.15.57.57 0 00.17-.46l1.3-8.8a.57.57 0 00-.36-.67z"/>
                        </svg>
                    </a>
                </div>
                <!-- END SECTION 2 -->
            </div>
            <!-- End Shop Sections Container -->

            <!-- Admin Access Link in Shop (NEW LOCATION) -->
            <div class="mt-6 pt-3 border-t border-gray-200 text-left">
                <a id="shop-admin-trigger" class="text-xs text-gray-400 hover:text-gray-600 cursor-pointer font-mono" title="Admin Access">
                    ğŸŒ Admin Console Access
                </a>
            </div>
        </div>
    </div>
    
    <!-- 3. Admin Modal Box -->
    <div id="admin-modal" class="modal-box" style="display: none;">
        <div class="modal-content !p-6 max-w-md">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h2 class="text-2xl font-bold text-gray-800">Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ù…ØªÛŒØ§Ø² ğŸ‘‘</h2>
                <button id="close-admin-button" class="text-gray-500 hover:text-gray-700 text-3xl font-light leading-none">
                    &times;
                </button>
            </div>
            
            <!-- Admin Login -->
            <div id="admin-login-view" class="space-y-4">
                <p class="text-red-600 font-semibold text-sm">âš ï¸ Ø¯Ø³ØªØ±Ø³ÛŒ ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ± Ù…Ø¬Ø§Ø² Ø§Ø³Øª âš ï¸</p>
                <input type="text" id="admin-username-input" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ù…Ø¯ÛŒØ±"
                       class="admin-input border-blue-300">
                <input type="password" id="admin-password-input" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ù…Ø­Ø±Ù…Ø§Ù†Ù‡"
                       class="admin-input border-blue-300">
                <button id="admin-login-button"
                        class="btn w-full bg-indigo-600 hover:bg-indigo-700 shadow-indigo-500/40 !mt-5">
                    ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ù¾Ù†Ù„
                </button>
                <p id="admin-login-message" class="text-center text-sm text-red-500 mt-2 hidden"></p>
            </div>
            
            <!-- Admin Panel -->
            <div id="admin-panel-view" class="space-y-5 hidden">
                <!-- Search -->
                <div class="p-3 border border-blue-300 bg-blue-50 rounded-lg space-y-2">
                    <h3 class="font-bold text-blue-700">Ø¬Ø³ØªØ¬ÙˆÛŒ Ú©Ø§Ø±Ø¨Ø± (Ø¨Ø§ Firebase UID)</h3>
                    <input type="text" id="admin-user-id-input" placeholder="Ø¢ÛŒØ¯ÛŒ Ø¯Ù‚ÛŒÙ‚ Ú©Ø§Ø±Ø¨Ø± (Firebase UID)"
                           class="admin-input text-gray-800">
                    <button id="admin-search-button"
                            class="btn w-full bg-blue-500 hover:bg-blue-600 !py-2 !px-4 !mt-0 !mb-1">
                        Ø¬Ø³ØªØ¬Ùˆ Ùˆ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø§Ù…ØªÛŒØ§Ø²
                    </button>
                    <p class="text-xs text-red-500 mt-1">
                        ØªÙˆØ¬Ù‡: Ø¨Ø±Ø§ÛŒ Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø§ÛŒØ¯ UID Ø¨Ù„Ù†Ø¯ ÙØ§ÛŒØ±Ø¨ÛŒØ³ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ù†Ù‡ Ø¢ÛŒØ¯ÛŒ Ø¹Ø¯Ø¯ÛŒ Ú©ÙˆØªØ§Ù‡).
                    </p>
                </div>
                
                <!-- Score Display -->
                <div id="admin-score-display" class="p-4 bg-gray-100 border border-gray-300 rounded-lg hidden">
                    <p class="text-gray-600 font-medium">Ø§Ù…ØªÛŒØ§Ø² Ø¬Ø§Ø±ÛŒ Ú©Ø§Ø±Ø¨Ø±:</p>
                    <p class="text-3xl font-extrabold text-indigo-700 mt-1">
                        Ø¨Ù‡ØªØ±ÛŒÙ† Ø§Ù…ØªÛŒØ§Ø²: <span id="admin-current-highscore">0</span> | Ø³Ú©Ù‡ Ú¯Ø±Ø¨Ù‡: <span id="admin-current-catcoins">0</span> ğŸ’°
                    </p>
                </div>

                <!-- Modify Score -->
                <div id="admin-modify-panel" class="p-3 border border-green-300 bg-green-50 rounded-lg space-y-2 hidden">
                    <h3 class="font-bold text-green-700">ØªØºÛŒÛŒØ± Ø³Ú©Ù‡ Ú¯Ø±Ø¨Ù‡ (Coins)</h3>
                    <input type="number" id="admin-point-amount-input" placeholder="Ù…Ù‚Ø¯Ø§Ø± Ø³Ú©Ù‡ (Ù…Ø«Ø§Ù„: 100)" value="100"
                           class="admin-input text-gray-800">
                    <div class="flex space-x-2 space-x-reverse">
                        <button id="admin-add-coins-button"
                                class="flex-1 bg-green-500 text-white p-2 rounded-lg font-bold hover:bg-green-600 transition duration-200">
                            Ø§ÙØ²ÙˆØ¯Ù† (+)
                        </button>
                        <button id="admin-subtract-coins-button"
                                class="flex-1 bg-red-500 text-white p-2 rounded-lg font-bold hover:bg-red-600 transition duration-200">
                            Ú©Ø³Ø± (-)
                        </button>
                    </div>
                </div>
                
                <p id="admin-operation-message" class="text-center text-sm mt-2 font-medium"></p>
            </div>
        </div>
    </div>
    
</div>

<script type="module">
    // --- FIREBASE IMPORTS ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    // SignOut, createUserWithEmail, signInWithEmail are removed as they are no longer needed
    import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

    // ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Firebase Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¨Ø§Ú¯
    setLogLevel('Debug');
    
    // --- GLOBAL FIREBASE/AUTH VARIABLES ---
    let firebaseApp;
    let db;
    let auth;
    let currentUserId = null; // Firebase UID
    let localNumericId = null; // Custom numeric ID for display
    let isAuthReady = false; 
    let unsubscribeSnapshot = null; // To hold the Firestore listener unsubscriber
    
    // --- PERSISTENCE/FIRESTORE PATHS ---
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-game-app-id';
    const GAME_DATA_COLLECTION = 'gameData';
    const GAME_PROFILE_DOCUMENT = 'profile';
    const LOCAL_ID_KEY = 'moshgorbe_numeric_id'; 
    const ADMIN_USER = "amirbinyaz"; // Hardcoded Admin Credential (secret)
    const ADMIN_PASS = "09178458526amirpc"; // Hardcoded Admin Credential (secret)

    // Utility to get the user-specific path
    function getUserDataPath(userId) {
        return `artifacts/${appId}/users/${userId}/${GAME_DATA_COLLECTION}/${GAME_PROFILE_DOCUMENT}`;
    }
    
    // --- GAME CONSTANTS ---
    const CANVAS_WIDTH = 560;
    const CANVAS_HEIGHT = 200;
    const GRAVITY = 0.6;
    const JUMP_VELOCITY = -12;
    const BASE_SPEED = 5; 
    const SPEED_INCREASE_RATE = 0.2; 
    let OBSTACLE_SPEED; 
    const MIN_OBSTACLE_INTERVAL = 900; 
    const MAX_OBSTACLE_INTERVAL = 2000; 
    const PARALLAX_SPEED_FACTOR = 0.2; 
    const EMOJI_SIZE = 35; // Base size used for scaling 
    const CAT_HEIGHT = EMOJI_SIZE * 1.1; 
    const CAT_WIDTH = EMOJI_SIZE * 1.6; 
    const DEFAULT_CAT_ID = 'tabby';

    const CAT_PALETTES = [
        { id: 'tabby', name: 'Ú¯Ø±Ø¨Ù‡ ØªØ¨ÛŒ (Ù¾ÛŒØ´ ÙØ±Ø¶)', price: 0, BODY_BASE: '#735f52', STRIPE_COLOR: '#52453a', BELLY_COLOR: '#e5e5e5', EYE_COLOR: '#44aa00', EAR_PINK: '#f0d0c0' },
        { id: 'black', name: 'Ú¯Ø±Ø¨Ù‡ Ø³ÛŒØ§Ù‡', price: 100, BODY_BASE: '#111111', STRIPE_COLOR: '#000000', BELLY_COLOR: '#333333', EYE_COLOR: '#ffcc00', EAR_PINK: '#555555' },
        { id: 'white', name: 'Ú¯Ø±Ø¨Ù‡ Ø³ÙÛŒØ¯', price: 100, BODY_BASE: '#ffffff', STRIPE_COLOR: '#e0e0e0', BELLY_COLOR: '#f0f0f0', EYE_COLOR: '#0099ff', EAR_PINK: '#ffaaaa' },
        { id: 'ginger', name: 'Ú¯Ø±Ø¨Ù‡ Ù¾Ø±ØªÙ‚Ø§Ù„ÛŒ', price: 200, BODY_BASE: '#ff9933', STRIPE_COLOR: '#cc6600', BELLY_COLOR: '#fff0d0', EYE_COLOR: '#009900', EAR_PINK: '#ffccaa' },
    ];
    
    // Ø¬Ù…Ù„Ø§Øª Ø·Ø¹Ù†Ù‡â€ŒØ¢Ù…ÛŒØ² Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¨Ø¹Ø¯ Ø§Ø² Ø¨Ø§Ø®Øª
    const SARCASTIC_MESSAGES = [
        "Ù†Ø§Ø±Ø§Ø­Øª Ù†Ø¨Ø§Ø´ÛŒØ¯ØŒ Ú¯Ø±Ø¨Ù‡â€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ø®ÙˆØ§Ø¨ÛŒØ¯Ù† Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù† Ù†Ù‡ Ù¾Ø±ÛŒØ¯Ù†! ğŸ˜´",
        "Ø§Ø­ØªÙ…Ø§Ù„Ø§Ù‹ Ù…Ù‚ØµØ± Ø¬Ø§Ø°Ø¨Ù‡â€ŒÛŒ Ø²Ù…ÛŒÙ† Ø¨ÙˆØ¯Ù‡ØŒ Ø´Ù…Ø§ Ú©Ù‡ Ø¹Ø§Ù„ÛŒ Ù¾Ø±ÛŒØ¯ÛŒØ¯! ğŸ˜‰",
        "ÙØ±Ø§Ù…ÙˆØ´ Ù†Ú©Ù†ÛŒØ¯ØŒ Ù…ÙˆØ´â€ŒÙ‡Ø§ Ø®ÛŒÙ„ÛŒ Ø³Ø±ÛŒØ¹â€ŒØªØ± Ø§Ø² Ø§ÙˆÙ† Ú†ÛŒØ²ÛŒ Ù‡Ø³ØªÙ† Ú©Ù‡ ÙÚ©Ø± Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯. Ø´Ø§ÛŒØ¯... ğŸ¤”",
        "ÛŒÙ‡ Ø±ÙˆØ² Ø¯ÛŒÚ¯Ù‡ Ø¨Ø±Ø§ÛŒ ØªÙ…Ø±ÛŒÙ† Ú©Ø±Ø¯Ù† Ùˆ Ù†Ù‡ Ø§Ù…Ø±ÙˆØ²! ğŸ‘",
        "Ù…Ø´Ú©Ù„ÛŒ Ù†ÛŒØ³ØªØŒ ÙÙ‚Ø· Ù„Ø§Ø²Ù… Ù†ÛŒØ³Øª Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ú†ÛŒØ²ÛŒ Ú©Ù‡ Ù…ÛŒâ€ŒØ¨ÛŒÙ†ÛŒØ¯ØŒ Ø¨Ù¾Ø±ÛŒØ¯! ğŸ¤£",
        "Ù…Ù‡Ù… Ø§ÛŒÙ†Ù‡ Ú©Ù‡ ØªÙ„Ø§Ø´ Ú©Ø±Ø¯ÛŒØ¯! (Ø¨Ù‡ØªØ±Ù‡ Ø¯ÙØ¹Ù‡ Ø¨Ø¹Ø¯ Ù…Ø­Ú©Ù…â€ŒØªØ± Ø¨Ù¾Ø±ÛŒØ¯) ğŸ’ª",
        "Ø´Ø§ÛŒØ¯ Ø¨Ø§ÛŒØ¯ Ø¨Ù‡ Ø¬Ø§ÛŒ Ú¯Ø±Ø¨Ù‡ØŒ Ø®Ø±Ú¯ÙˆØ´ Ø§Ù†ØªØ®Ø§Ø¨ Ù…ÛŒâ€ŒÚ©Ø±Ø¯ÛŒØ¯. ğŸ°",
        "Ø¹Ø§Ù„ÛŒÙ‡! Ø­Ø¯Ø§Ù‚Ù„ Ø¯ÛŒÚ¯Ù‡ Ù…Ø¬Ø¨ÙˆØ± Ù†ÛŒØ³ØªÛŒØ¯ Ø¨Ø§ Ø§ÙˆÙ† Ù…ÙˆØ´ Ø³Ø± Ùˆ Ú©Ù„Ù‡ Ø¨Ø²Ù†ÛŒØ¯. Ø§Ø³ØªØ±Ø§Ø­Øª Ú©Ù†ÛŒØ¯! ğŸ§˜â€â™€ï¸"
    ];
    
    // Ø¬Ù…Ù„Ø§Øª Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ø¨Ø§Ø®Øª Ú¯Ø±Ø¨Ù‡
    const catLossPhrases = [
        "Ø§ÙˆÙ‡ Ø³Ø±Ù… Ø´Ú©Ø³Øª! ğŸ¤•", "Ø§ÛŒÙ† Ù…ÙˆØ´ Ø§Ø±Ø²Ø´ Ø§ÛŒÙ† Ù‡Ù…Ù‡ Ø¯Ø±Ø¯Ø³Ø± Ø±Ùˆ Ù†Ø¯Ø§Ø±Ù‡! ğŸ˜¤", "Ú©Ù Ø§ÛŒÙ† Ø®ÙˆÙ†Ù‡ Ø®ÛŒÙ„ÛŒ Ù„ÛŒØ²Ù‡! ğŸ˜«",
        "Ø§Ø®! Ù¾Ø§ÛŒ Ù…Ù†! ğŸ¾", "Ù„Ø¹Ù†Øª Ø¨Ù‡ Ø¬Ø¹Ø¨Ù‡â€ŒÙ‡Ø§! ğŸ“¦", "ÙÚ©Ø± Ú©Ù†Ù… Û¹ ØªØ§ Ø¬ÙˆÙ†Ù… ØªÙ…ÙˆÙ… Ø´Ø¯! ğŸ‘»"
    ];

    // --- DOM Elements ---
    const canvas = document.getElementById('game-canvas');
    const ctx = canvas.getContext('2d');
    const scoreDisplay = document.getElementById('score-display');
    const highScoreDisplay = document.getElementById('high-score-display'); 
    const coinDisplay = document.getElementById('coin-display'); 
    const messageBox = document.getElementById('message-box');
    const loadingPrompt = document.getElementById('loading-prompt');
    const startPrompt = document.getElementById('start-prompt');
    const gameOverDetails = document.getElementById('game-over-details');
    const messageTitle = document.getElementById('message-title'); 
    const messageText = document.getElementById('message-text'); 
    const sarcasticMessage = document.getElementById('sarcastic-message'); 
    const restartButton = document.getElementById('restart-button'); 
    const shopButton = document.getElementById('shop-button');
    const shopBox = document.getElementById('shop-box'); 
    const closeShopButton = document.getElementById('close-shop-button');
    const shopItemsContainer = document.getElementById('shop-items-container');
    const shopCoinDisplay = document.getElementById('shop-coin-display');
    // const authModal = document.getElementById('auth-modal'); // Removed Auth Modal
    const signOutButton = document.getElementById('sign-out-button');
    const userStatus = document.getElementById('user-status');
    const userInfoText = document.getElementById('user-info-text');
    const teleUidDisplay = document.getElementById('tele-uid-display');
    
    // --- ADMIN DOM ELEMENTS ---
    const adminModal = document.getElementById('admin-modal');
    const closeAdminButton = document.getElementById('close-admin-button');
    const shopAdminTrigger = document.getElementById('shop-admin-trigger'); 
    const adminLoginView = document.getElementById('admin-login-view');
    const adminPanelView = document.getElementById('admin-panel-view');
    const adminUsernameInput = document.getElementById('admin-username-input');
    const adminPasswordInput = document.getElementById('admin-password-input');
    const adminLoginButton = document.getElementById('admin-login-button');
    const adminLoginMessage = document.getElementById('admin-login-message');
    const adminUserIdInput = document.getElementById('admin-user-id-input');
    const adminSearchButton = document.getElementById('admin-search-button');
    const adminScoreDisplay = document.getElementById('admin-score-display');
    const adminCurrentHighscore = document.getElementById('admin-current-highscore');
    const adminCurrentCatcoins = document.getElementById('admin-current-catcoins');
    const adminModifyPanel = document.getElementById('admin-modify-panel');
    const adminPointAmountInput = document.getElementById('admin-point-amount-input');
    const adminAddCoinsButton = document.getElementById('admin-add-coins-button');
    const adminSubtractCoinsButton = document.getElementById('admin-subtract-coins-button');
    const adminOperationMessage = document.getElementById('admin-operation-message');

    // --- Game Variables and State ---
    let gameRunning = false;
    let score = 0;
    let obstacles = [];
    let particles = []; 
    let nextObstacleTime = 0;
    let animationFrameId;
    let mousePositionX; 
    
    let highScore = 0; 
    let catCoins = 0; 
    let unlockedCats = [DEFAULT_CAT_ID]; 
    let currentCatId = DEFAULT_CAT_ID;
    let dataChanged = false; // Flag to check if save is needed
    
    let lastSearchedAdminUserId = null; // For Admin Panel state

    // --- UTILITIES & DRAWING FUNCTIONS ---

    function drawCat(ctx, x, y, width, height, palette) {
        const p = palette; 
        const headSize = width * 0.55;
        const tailLength = width * 0.7;
        const tailThickness = width * 0.1;

        // 1. Tail (Behind body, drawn first)
        ctx.fillStyle = p.BODY_BASE;
        ctx.beginPath();
        ctx.moveTo(x + width * 0.1, y + height * 0.9);
        ctx.bezierCurveTo(x - tailLength * 0.5, y + height * 0.5,
                          x + width * 0.2, y + height * 0.2,
                          x + width * 0.8, y + headSize * 0.2); // Neck
        ctx.lineTo(x + width * 0.1, y + height * 0.9 + tailThickness); 
        ctx.closePath();
        ctx.fill();

        // 2. Body
        ctx.fillStyle = p.BODY_BASE;
        ctx.beginPath();
        // Main body shape (more curved, like a side view)
        ctx.moveTo(x + width * 0.1, y + height * 0.95); // Start at back foot
        ctx.bezierCurveTo(x + width * 0.1, y + height * 0.1, 
                          x + width * 0.6, y, 
                          x + width * 0.8, y + headSize * 0.2); // Neck
        ctx.lineTo(x + width * 0.8, y + height * 0.95); // Front leg area
        ctx.closePath();
        ctx.fill();
        
        // 3. Belly (Lighter color - simple ellipse on the lower half)
        ctx.fillStyle = p.BELLY_COLOR;
        ctx.beginPath();
        ctx.ellipse(x + width * 0.45, y + height * 0.8, width * 0.35, height * 0.15, 0, 0, Math.PI * 2);
        ctx.fill();

        // 4. Head
        ctx.fillStyle = p.BODY_BASE;
        ctx.beginPath();
        ctx.arc(x + width * 0.8, y + headSize * 0.6, headSize * 0.6, 0, Math.PI * 2);
        ctx.fill();

        // 5. Ears (Left ear)
        ctx.fillStyle = p.BODY_BASE;
        ctx.beginPath();
        ctx.moveTo(x + width * 0.65, y + headSize * 0.05); 
        ctx.lineTo(x + width * 0.8, y - height * 0.2); // Ear tip
        ctx.lineTo(x + width * 0.9, y + headSize * 0.2);
        ctx.fill();
        
        // Inner ear
        ctx.fillStyle = p.EAR_PINK;
        ctx.beginPath();
        ctx.moveTo(x + width * 0.7, y + headSize * 0.15);
        ctx.lineTo(x + width * 0.8, y - height * 0.1);
        ctx.lineTo(x + width * 0.88, y + headSize * 0.2);
        ctx.fill();

        // 6. Eye (Simple green/yellow circle)
        ctx.fillStyle = p.EYE_COLOR;
        ctx.beginPath();
        ctx.arc(x + width * 0.85, y + headSize * 0.5, headSize * 0.08, 0, Math.PI * 2);
        ctx.fill();
        
        // 7. Stripes/Details (Tabby/Ginger)
        if (p.id === 'tabby' || p.id === 'ginger') {
            ctx.strokeStyle = p.STRIPE_COLOR;
            ctx.lineWidth = 1.5;
            ctx.beginPath();
            // Body stripes
            ctx.moveTo(x + width * 0.25, y + height * 0.5);
            ctx.lineTo(x + width * 0.35, y + height * 0.7);
            ctx.moveTo(x + width * 0.45, y + height * 0.4);
            ctx.lineTo(x + width * 0.55, y + height * 0.6);
            ctx.stroke();
        }

        // 8. Simple Paws
        ctx.fillStyle = p.BODY_BASE;
        ctx.fillRect(x + width * 0.1, y + height - 5, width * 0.15, 5); // Back paw
        ctx.fillRect(x + width * 0.7, y + height - 5, width * 0.15, 5); // Front paw
    }

    function drawBox(ctx, x, y, width, height) {
        const depth = width * 0.2;
        const lidHeight = height * 0.05; 
        
        // Colors for cardboard effect
        const frontColor = '#B08968'; 
        const sideColor = '#9E7754';   
        const topColor = '#C6A98C';   
        const tapeColor = '#E3D5CA';   

        // Adjust Y to account for lid height when drawing the box itself
        const boxY = y + lidHeight;
        const boxHeight = height - lidHeight;

        // 1. Front Face (Largest surface)
        ctx.fillStyle = frontColor;
        ctx.fillRect(x, boxY, width, boxHeight); 
        
        // 2. Right Side Face (slanted for 3D effect)
        ctx.fillStyle = sideColor;
        ctx.beginPath();
        ctx.moveTo(x + width, boxY);
        ctx.lineTo(x + width + depth, boxY + depth * 0.5); 
        ctx.lineTo(x + width + depth, boxY + boxHeight + depth * 0.5); 
        ctx.lineTo(x + width, boxY + boxHeight);
        ctx.closePath();
        ctx.fill();

        // 3. Top Lid
        ctx.fillStyle = topColor;
        ctx.beginPath();
        ctx.moveTo(x, boxY); 
        ctx.lineTo(x + depth, boxY + depth * 0.5); 
        ctx.lineTo(x + width + depth, boxY + depth * 0.5); 
        ctx.lineTo(x + width, boxY); 
        ctx.closePath();
        ctx.fill();
        
        // 4. Sealing Tape (Across the middle of the lid)
        ctx.fillStyle = tapeColor;
        const tapeWidth = width * 0.8;
        const tapeHeight = 5;
        const tapeOffset = depth * 0.5; 
        
        // Draw tape on the front face (simulated projection)
        ctx.fillRect(x + width * 0.1, boxY, tapeWidth, tapeHeight);
        
        // Draw tape on the top face (angled)
        ctx.beginPath();
        ctx.moveTo(x + width * 0.1, boxY);
        ctx.lineTo(x + width * 0.1 + depth, boxY + tapeOffset);
        ctx.lineTo(x + width * 0.1 + depth + tapeWidth, boxY + tapeOffset);
        ctx.lineTo(x + width * 0.1 + tapeWidth, boxY);
        ctx.closePath();
        ctx.fill();
        
        // 5. Mouse icon (for context)
        ctx.fillStyle = '#222';
        ctx.font = '18px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('ğŸ­', x + width / 2, boxY + boxHeight * 0.6);
    }
    
    // --- SOUNDS (Tone.js) ---
    const jumpSynth = new Tone.MembraneSynth().toDestination();
    const scoreSynth = new Tone.PolySynth(Tone.Synth).toDestination();
    const collisionSynth = new Tone.NoiseSynth({
        noise: { type: "white" },
        envelope: { attack: 0.005, decay: 0.1, sustain: 0, release: 0.1 }
    }).toDestination();
    const buySynth = new Tone.Synth({
        oscillator: { type: "sine" },
        envelope: { attack: 0.01, decay: 0.1, sustain: 0.05, release: 0.2 }
    }).toDestination();
    
    function playJumpSound() { jumpSynth.triggerAttackRelease("C4", "8n"); }
    function playScoreSound() { scoreSynth.triggerAttackRelease(["E5", "G5", "C6"], "16n"); }
    function playCollisionSound() { collisionSynth.triggerAttackRelease("8n"); }
    function playBuySound(success) { 
        if (success) {
             buySynth.triggerAttackRelease(["C5", "E5", "G5"], "8n"); 
        } else {
             buySynth.triggerAttackRelease("C3", "16n");
        }
    }


    // --- PERSISTENT NUMERIC ID LOGIC ---

    /**
     * Generates a permanent, unique numeric ID and stores it in localStorage.
     * This ID is used for display and the 'tele-uid' (Telegram) link, as requested.
     */
    function getOrCreateLocalNumericId() {
        let storedId = localStorage.getItem(LOCAL_ID_KEY);
        
        if (storedId) {
            localNumericId = storedId;
        } else {
            // Generate a large random number (10 digits) for uniqueness
            // Note: This ID is NOT the Firebase UID, which is used for data security.
            const min = 1000000000;
            const max = 9999999999;
            const newId = Math.floor(Math.random() * (max - min + 1)) + min;
            localNumericId = newId.toString();
            localStorage.setItem(LOCAL_ID_KEY, localNumericId);
        }
        return localNumericId;
    }
    
    // --- FIRESTORE DATA LOGIC ---

    function loadUserData() {
        if (!currentUserId) return;

        if (unsubscribeSnapshot) {
            unsubscribeSnapshot();
        }

        const userDocRef = doc(db, getUserDataPath(currentUserId));
        
        unsubscribeSnapshot = onSnapshot(userDocRef, (docSnapshot) => {
            if (docSnapshot.exists()) {
                const data = docSnapshot.data();
                
                highScore = data.highScore || 0;
                catCoins = data.catCoins || 0;
                // We don't overwrite localNumericId, but we confirm it's in the profile
                localNumericId = data.localNumericId || getOrCreateLocalNumericId(); 
                
                try {
                    unlockedCats = JSON.parse(data.unlockedCatsJson || '[]');
                    if (unlockedCats.length === 0) {
                         unlockedCats = [DEFAULT_CAT_ID];
                    }
                } catch (e) {
                    console.error("Error parsing unlockedCats:", e);
                    unlockedCats = [DEFAULT_CAT_ID];
                }
                currentCatId = data.currentCatId || DEFAULT_CAT_ID;

                console.log("Game data loaded from Firestore. Numeric ID:", localNumericId);
            } else {
                console.log("No profile found. Setting up new profile...");
                highScore = 0;
                catCoins = 0;
                unlockedCats = [DEFAULT_CAT_ID];
                currentCatId = DEFAULT_CAT_ID;
                localNumericId = getOrCreateLocalNumericId(); // Ensure ID is generated
                saveUserData(); // Create the initial document
            }

            updateGameUI();
            
            loadingPrompt.style.display = 'none'; 
            startPrompt.style.display = 'block'; 
            messageBox.style.display = 'flex';
            gameOverDetails.style.display = 'none'; 

        }, (error) => {
            console.error("Error fetching Firestore data:", error);
        });
    }

    async function saveUserData() {
        if (!currentUserId) {
            console.warn("Cannot save data: User ID is missing.");
            return;
        }

        // Always ensure the numeric ID is up-to-date locally before saving
        getOrCreateLocalNumericId();
        
        if (!dataChanged) {
            return; 
        }
        
        const dataToSave = {
            userId: currentUserId, // Firebase UID
            localNumericId: localNumericId, // Numeric ID for display
            highScore: highScore,
            catCoins: catCoins,
            unlockedCatsJson: JSON.stringify(unlockedCats), 
            currentCatId: currentCatId,
            lastUpdated: new Date().toISOString()
        };
        
        try {
            const userDocRef = doc(db, getUserDataPath(currentUserId));
            // Use setDoc with merge: true to avoid deleting the entire document
            await setDoc(userDocRef, dataToSave, { merge: true });
            console.log("Game data saved to Firestore successfully.");
            dataChanged = false;
        } catch (error) {
            console.error("Error saving game data:", error);
        }
    }
    
    // --- UI UPDATES ---

    function updateGameUI() {
        highScoreDisplay.textContent = `Ø¨Ù‡ØªØ±ÛŒÙ†: ${highScore}`;
        coinDisplay.textContent = `Ø³Ú©Ù‡ Ú¯Ø±Ø¨Ù‡: ${catCoins} ğŸ’°`;
        
        // Update User Status Bar with the numeric ID
        if (localNumericId) {
            userStatus.style.display = 'flex';
            userInfoText.textContent = `Ø¢ÛŒØ¯ÛŒ Ø¯Ø³ØªÚ¯Ø§Ù‡ Ø´Ù…Ø§: ${localNumericId}`;
            teleUidDisplay.textContent = localNumericId;
        } else {
            userStatus.style.display = 'none';
            teleUidDisplay.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...';
        }
        
        // Update Shop UI if open
        if (shopBox.style.display === 'flex') {
            shopCoinDisplay.textContent = `Ø³Ú©Ù‡ Ú¯Ø±Ø¨Ù‡ Ø´Ù…Ø§: ${catCoins} ğŸ’°`;
            renderShopItems();
        }
    }


    // --- GAME LOGIC FUNCTIONS ---

    function resetGame() {
        // Since we are using Anonymous Auth, the user is always "logged in"
        if (!currentUserId) {
             console.error("Authentication not ready. Cannot start game.");
             return;
        }

        gameRunning = true;
        score = 0;
        obstacles = [];
        particles = [];
        OBSTACLE_SPEED = BASE_SPEED; 
        mousePositionX = CANVAS_WIDTH * 2 + 500;
        nextObstacleTime = performance.now() + 1500; 
        
        player.y = CANVAS_HEIGHT - player.height;
        player.vy = 0;
        player.isJumping = false;
        
        scoreDisplay.textContent = 'Ø§Ù…ØªÛŒØ§Ø²: 0';
        messageBox.style.display = 'none';
        shopBox.style.display = 'none'; 
        adminModal.style.display = 'none'; 
        
        gameOverDetails.style.display = 'none'; 
        startPrompt.style.display = 'block'; 
        
        if (animationFrameId) {
            cancelAnimationFrame(animationFrameId);
        }
        gameLoop();
    }

    function gameOver(isWin = false) { 
        gameRunning = false;
        cancelAnimationFrame(animationFrameId);
        
        const previousHighScore = highScore; 
        let coinsEarned = 0;
        let messageSuffix = '';

        if (score > previousHighScore) {
            highScore = score; 
            coinsEarned = score; 
            messageSuffix = `+${coinsEarned} Ø³Ú©Ù‡ Ú¯Ø±Ø¨Ù‡ (Ø±Ú©ÙˆØ±Ø¯ Ø¬Ø¯ÛŒØ¯!) Ú©Ø³Ø¨ Ú©Ø±Ø¯ÛŒØ¯! ğŸ¥³`;
            dataChanged = true; 
        } else {
            coinsEarned = 0;
            messageSuffix = `Ø³Ú©Ù‡ Ø¬Ø¯ÛŒØ¯ÛŒ Ú©Ø³Ø¨ Ù†Ú©Ø±Ø¯ÛŒØ¯. Ø¨Ø§ÛŒØ¯ Ø±Ú©ÙˆØ±Ø¯ ${previousHighScore} Ø±Ø§ Ø¨Ø´Ú©Ù†ÛŒØ¯. ğŸ˜”`;
        }
        
        catCoins += coinsEarned;
        if (coinsEarned > 0) dataChanged = true;

        playCollisionSound(); 

        startPrompt.style.display = 'none';
        gameOverDetails.style.display = 'block'; 
        
        if (isWin) {
            messageTitle.textContent = 'Ø´Ú©Ø§Ø± Ù…ÙˆÙÙ‚! Ù…ÙˆØ´ Ø¯Ø³ØªÚ¯ÛŒØ± Ø´Ø¯! ğŸ‰';
            messageText.innerHTML = `Ø´Ù…Ø§ Ù¾Ø³ Ø§Ø² ${score} Ù¾Ø±Ø´ Ù…ÙˆÙÙ‚ØŒ Ø¨Ø±Ù†Ø¯Ù‡ Ø´Ø¯ÛŒØ¯! ğŸ…<br>${messageSuffix}`;
            sarcasticMessage.textContent = ''; 
            restartButton.textContent = 'Ø¨Ø§Ø²ÛŒ Ù…Ø¬Ø¯Ø¯';
        } else {
            const randomIndexTitle = Math.floor(Math.random() * catLossPhrases.length);
            const randomIndexSarcastic = Math.floor(Math.random() * SARCASTIC_MESSAGES.length);
            
            messageTitle.textContent = catLossPhrases[randomIndexTitle]; 
            messageText.innerHTML = `Ø§Ù…ØªÛŒØ§Ø² Ù†Ù‡Ø§ÛŒÛŒ Ø´Ù…Ø§: ${score}<br>${messageSuffix}`;
            
            // Ù†Ù…Ø§ÛŒØ´ Ø¬Ù…Ù„Ù‡ Ø§Ù†Ú¯ÛŒØ²Ø´ÛŒ/Ø·Ø¹Ù†Ù‡â€ŒØ¢Ù…ÛŒØ²
            sarcasticMessage.textContent = SARCASTIC_MESSAGES[randomIndexSarcastic]; 
            
            restartButton.textContent = 'Ø´Ø±ÙˆØ¹ Ù…Ø¬Ø¯Ø¯';
        }
        
        messageBox.style.display = 'flex';
        
        saveUserData();
    }
    
    function checkCollision() {
        for (const obs of obstacles) {
            if (
                // hitbox is slightly smaller than the drawn box for forgiveness
                player.x + player.width * 0.9 > obs.x && 
                player.x + player.width * 0.2 < obs.x + obs.width + 10 && 
                player.y + player.height > obs.y + obs.height * 0.1 
            ) {
                return true; 
            }
        }
        return false;
    }

    function spawnObstacle(timestamp) {
        if (timestamp > nextObstacleTime) {
            obstacles.push(new Obstacle(CANVAS_WIDTH));
            const interval = MIN_OBSTACLE_INTERVAL + Math.random() * (MAX_OBSTACLE_INTERVAL - MIN_OBSTACLE_INTERVAL);
            nextObstacleTime = timestamp + interval;
        }
    }

    function drawMouse(ctx, x, y) {
        // Simple representation of the mouse (The target)
        ctx.fillStyle = '#6b7280';
        ctx.beginPath();
        ctx.arc(x, y, 10, 0, Math.PI * 2);
        ctx.fill();
        ctx.font = '16px Vazirmatn';
        ctx.fillStyle = '#111';
        ctx.textAlign = 'center';
        ctx.fillText('ğŸ­', x, y + 5);
    }

    function updateGame(timestamp) {
        ctx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT); 

        // Draw Sky (handled by CSS background, but we can draw a simple ground line)
        // Draw the dark ground line
        ctx.fillStyle = '#443021';
        ctx.fillRect(0, CANVAS_HEIGHT - 5, CANVAS_WIDTH, 5);


        // Draw the mouse (target)
        drawMouse(ctx, mousePositionX, CANVAS_HEIGHT - 20);

        player.update();
        player.draw();
        
        spawnObstacle(timestamp);
        
        for (let i = 0; i < obstacles.length; i++) {
            const obs = obstacles[i];
            obs.update();
            obs.draw();

            if (obs.x + obs.width + 10 < 0) {
                score++;
                playScoreSound(); 
                OBSTACLE_SPEED += SPEED_INCREASE_RATE; 
                mousePositionX -= 2.04; 
                obstacles.splice(i, 1);
                i--; 
            }
        }
        
        if (checkCollision()) {
            gameOver(); 
            return;
        }

        if (mousePositionX <= 100) { 
             gameOver(true); 
             return;
        }

        scoreDisplay.textContent = 'Ø§Ù…ØªÛŒØ§Ø²: ' + score;
        animationFrameId = requestAnimationFrame(gameLoop);
    }
    
    function gameLoop(timestamp) {
        if (gameRunning && currentUserId) {
            updateGame(timestamp);
        }
    }


    // --- SHOP LOGIC ---
    function openShop() {
        gameRunning = false; 
        if (animationFrameId) cancelAnimationFrame(animationFrameId);
        messageBox.style.display = 'none';
        adminModal.style.display = 'none';
        shopBox.style.display = 'flex';
        renderShopItems();
    }

    function closeShop() {
        shopBox.style.display = 'none';
        
        // Return to the game message box
        messageBox.style.display = 'flex';
        if (score > 0) {
             startPrompt.style.display = 'none';
             gameOverDetails.style.display = 'block';
        } else {
             startPrompt.style.display = 'block';
             gameOverDetails.style.display = 'none';
        }
        
        if (dataChanged) saveUserData();
    }
    
    function buyCat(catId) {
        const cat = CAT_PALETTES.find(p => p.id === catId);
        if (!cat || cat.price === 0 || unlockedCats.includes(catId)) return;

        if (catCoins >= cat.price) {
            catCoins -= cat.price;
            unlockedCats.push(catId);
            currentCatId = catId; 
            dataChanged = true; 
            renderShopItems();
            playBuySound(true);
        } else {
            playBuySound(false);
        }
    }

    function selectCat(catId) {
        if (unlockedCats.includes(catId)) {
            currentCatId = catId;
            dataChanged = true; 
            renderShopItems(); 
        }
    }
    
    // Globalize select/buy functions for onclick in HTML strings
    window.selectCat = selectCat;
    window.buyCat = buyCat;

    function renderShopItems() {
        shopCoinDisplay.textContent = `Ø³Ú©Ù‡ Ú¯Ø±Ø¨Ù‡ Ø´Ù…Ø§: ${catCoins} ğŸ’°`;
        shopItemsContainer.innerHTML = '';

        CAT_PALETTES.forEach(cat => {
            const isUnlocked = unlockedCats.includes(cat.id);
            const isSelected = cat.id === currentCatId;
            const isFree = cat.price === 0;

            let buttonHTML = '';
            let itemClass = 'shop-item border-gray-300';

            if (isSelected) {
                buttonHTML = `<button class="btn bg-gray-500 !py-2 !px-4 !m-0 !mt-2">Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ âœ…</button>`;
                itemClass = 'shop-item selected';
            } else if (isUnlocked) {
                buttonHTML = `<button onclick="selectCat('${cat.id}')" class="btn bg-green-500 hover:bg-green-600 !py-2 !px-4 !m-0 !mt-2">Ø§Ù†ØªØ®Ø§Ø¨</button>`;
            } else if (isFree) {
                 buttonHTML = `<button onclick="buyCat('${cat.id}')" class="btn bg-green-500 hover:bg-green-600 !py-2 !px-4 !m-0 !mt-2">Ø¯Ø±ÛŒØ§ÙØª Ø±Ø§ÛŒÚ¯Ø§Ù†</button>`;
            } else {
                buttonHTML = `<button onclick="buyCat('${cat.id}')" class="btn bg-yellow-500 hover:bg-yellow-600 !py-2 !px-4 !m-0 !mt-2">${cat.price} ğŸ’° Ø®Ø±ÛŒØ¯</button>`;
                itemClass = 'shop-item border-gray-500'; 
            }
            
            // Preview Cat (Simple emoji placeholder in the shop UI)
            const catEmoji = cat.id === 'black' ? 'ğŸˆâ€â¬›' : cat.id === 'white' ? 'ğŸˆ' : cat.id === 'ginger' ? 'ğŸ§¡' : 'ğŸˆ';

            const itemHTML = `
                <div class="${itemClass} flex flex-col items-center">
                    <div style="font-size: 3rem; line-height: 1;">${catEmoji}</div>
                    <h3 class="font-bold text-lg mt-2">${cat.name}</h3>
                    ${isUnlocked && !isSelected ? `<p class="text-sm text-gray-500">Ù¾ÙˆØ³ØªÙ‡ Ø¢Ø²Ø§Ø¯ Ø§Ø³Øª</p>` : isFree ? `<p class="text-sm text-green-600">Ø±Ø§ÛŒÚ¯Ø§Ù†</p>` : `<p class="text-sm text-yellow-700">${cat.price} Ø³Ú©Ù‡</p>`}
                    ${buttonHTML}
                </div>
            `;
            shopItemsContainer.insertAdjacentHTML('beforeend', itemHTML);
        });
    }

    // --- ADMIN PANEL LOGIC ---
    
    function showAdminMessage(element, message, type) {
        element.textContent = message;
        element.className = `text-center text-sm mt-2 font-medium ${type === 'error' ? 'text-red-600' : 'text-green-600'}`;
        element.classList.remove('hidden');
    }
    
    function openAdminModal() {
        // Close Shop and open Admin
        shopBox.style.display = 'none'; 
        gameRunning = false; 
        if (animationFrameId) cancelAnimationFrame(animationFrameId);
        messageBox.style.display = 'none';

        adminModal.style.display = 'flex';
        
        // Reset admin view to login state initially
        adminPanelView.classList.add('hidden');
        adminLoginView.classList.remove('hidden');
        adminLoginMessage.classList.add('hidden');
        adminUserIdInput.value = '';
        adminScoreDisplay.classList.add('hidden');
        adminModifyPanel.classList.add('hidden');
        lastSearchedAdminUserId = null;
        adminUsernameInput.value = '';
        adminPasswordInput.value = '';
        adminOperationMessage.classList.add('hidden');
    }
    
    function closeAdminModal() {
        adminModal.style.display = 'none';
        
        // Return to the shop modal after closing the admin panel
        openShop();
    }
    
    // Admin Login Handler
    adminLoginButton.addEventListener('click', () => {
        const username = adminUsernameInput.value.trim();
        const password = adminPasswordInput.value.trim();
        
        if (username === ADMIN_USER && password === ADMIN_PASS) {
            adminLoginView.classList.add('hidden');
            adminPanelView.classList.remove('hidden');
            showAdminMessage(adminOperationMessage, 'ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ². Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø§Ù…ØªÛŒØ§Ø²Ø§Øª Ø±Ø§ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ù†ÛŒØ¯.', 'success');
        } else {
            showAdminMessage(adminLoginMessage, 'Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª.', 'error');
        }
    });

    // Admin Search Handler
    adminSearchButton.addEventListener('click', async () => {
        const userId = adminUserIdInput.value.trim(); // This is Firebase UID
        if (!userId) {
            showAdminMessage(adminOperationMessage, 'Ù„Ø·ÙØ§Ù‹ Firebase UID Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.', 'error');
            adminScoreDisplay.classList.add('hidden');
            adminModifyPanel.classList.add('hidden');
            return;
        }

        showAdminMessage(adminOperationMessage, 'Ø¯Ø± Ø­Ø§Ù„ Ø¬Ø³ØªØ¬Ùˆ...', 'success');
        lastSearchedAdminUserId = userId;
        
        try {
            const userDocRef = doc(db, getUserDataPath(userId));
            const docSnap = await getDoc(userDocRef);

            let highscore = 0;
            let coins = 0;
            
            if (docSnap.exists()) {
                const data = docSnap.data();
                highscore = data.highScore || 0;
                coins = data.catCoins || 0;
                const numericId = data.localNumericId || 'Ù†Ø§Ù…Ø´Ø®Øµ';
                showAdminMessage(adminOperationMessage, `Ø§Ù…ØªÛŒØ§Ø² Ú©Ø§Ø±Ø¨Ø± (Ø¢ÛŒØ¯ÛŒ Ø¹Ø¯Ø¯ÛŒ: ${numericId}) Ù¾ÛŒØ¯Ø§ Ø´Ø¯.`, 'success');
            } else {
                showAdminMessage(adminOperationMessage, `Ú©Ø§Ø±Ø¨Ø± ${userId} Ù‡Ù†ÙˆØ² Ù¾Ø±ÙˆÙØ§ÛŒÙ„ÛŒ Ù†Ø³Ø§Ø®ØªÙ‡ Ø§Ø³Øª. Ø§Ù…ØªÛŒØ§Ø² Ø§ÙˆÙ„ÛŒÙ‡ 0 Ø¯Ø± Ù†Ø¸Ø± Ú¯Ø±ÙØªÙ‡ Ø´Ø¯.`, 'success');
            }
            
            adminCurrentHighscore.textContent = highscore;
            adminCurrentCatcoins.textContent = coins;
            adminScoreDisplay.classList.remove('hidden');
            adminModifyPanel.classList.remove('hidden');

        } catch (error) {
            console.error("Admin Search Error:", error);
            showAdminMessage(adminOperationMessage, `Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ø¯Ù‡: ${error.message}`, 'error');
            adminScoreDisplay.classList.add('hidden');
            adminModifyPanel.classList.add('hidden');
        }
    });
    
    // Admin Modify Handler
    async function modifyUserCoins(operation) {
        if (!lastSearchedAdminUserId) {
            showAdminMessage(adminOperationMessage, 'Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ Ø¬Ø³ØªØ¬Ùˆ Ú©Ù†ÛŒØ¯.', 'error');
            return;
        }
        
        const amount = parseInt(adminPointAmountInput.value, 10);
        if (isNaN(amount) || amount <= 0) {
            showAdminMessage(adminOperationMessage, 'Ù…Ù‚Ø¯Ø§Ø± Ø³Ú©Ù‡ ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª.', 'error');
            return;
        }

        if (adminPanelView.classList.contains('hidden')) {
             showAdminMessage(adminOperationMessage, 'Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ø´ÙˆÛŒØ¯.', 'error');
             return;
        }


        const isAdding = operation === 'add';
        const multiplier = isAdding ? 1 : -1;
        
        try {
            showAdminMessage(adminOperationMessage, isAdding ? 'Ø¯Ø± Ø­Ø§Ù„ Ø§ÙØ²ÙˆØ¯Ù† Ø³Ú©Ù‡...' : 'Ø¯Ø± Ø­Ø§Ù„ Ú©Ø³Ø± Ø³Ú©Ù‡...', 'success');

            const userDocRef = doc(db, getUserDataPath(lastSearchedAdminUserId));
            
            // Get current value
            const docSnap = await getDoc(userDocRef);
            const currentCoins = docSnap.exists() ? (docSnap.data().catCoins || 0) : 0;
            const newCoins = Math.max(0, currentCoins + (amount * multiplier)); // Ensure coins don't go below zero

            await setDoc(userDocRef, { catCoins: newCoins }, { merge: true });

            adminCurrentCatcoins.textContent = newCoins;
            showAdminMessage(adminOperationMessage, `${amount} Ø³Ú©Ù‡ ${isAdding ? 'Ø§Ø¶Ø§ÙÙ‡' : 'Ú©Ø³Ø±'} Ø´Ø¯. Ø³Ú©Ù‡ Ø¬Ø¯ÛŒØ¯: ${newCoins} ğŸ’°`, 'success');
            
            // If the admin modified their own account, update the game's state immediately
            if (lastSearchedAdminUserId === currentUserId) {
                catCoins = newCoins;
                updateGameUI();
            }

        } catch (error) {
            console.error("Admin Modify Error:", error);
            showAdminMessage(adminOperationMessage, `Ø®Ø·Ø§ Ø¯Ø± Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø³Ú©Ù‡: ${error.message}`, 'error');
        }
    }
    
    adminAddCoinsButton.addEventListener('click', () => modifyUserCoins('add'));
    adminSubtractCoinsButton.addEventListener('click', () => modifyUserCoins('subtract'));
    closeAdminButton.addEventListener('click', closeAdminModal);
    
    // Admin Trigger inside Shop
    shopAdminTrigger.addEventListener('click', openAdminModal);


    // --- INITIALIZATION ---
    
    function initializeFirebase() {
        getOrCreateLocalNumericId(); // Generate numeric ID immediately
        
        try {
            const firebaseConfig = JSON.parse(__firebase_config);
            firebaseApp = initializeApp(firebaseConfig);
            auth = getAuth(firebaseApp);
            db = getFirestore(firebaseApp);
            
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUserId = user.uid; // Use Firebase UID for Firestore Path
                    loadUserData(); 
                    console.log(`User ${currentUserId} authenticated (Anonymous).`);
                } else {
                    currentUserId = null;
                    
                    try {
                        const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                        if (token) {
                            await signInWithCustomToken(auth, token);
                        } else {
                            // Fallback to anonymous sign-in
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                         console.error("Error with initial/anonymous sign-in:", error);
                         // If sign-in fails, show error or continue in guest mode (but game won't save)
                         loadingPrompt.innerHTML = '<h2 class="message-title text-4xl text-red-600">Ø®Ø·Ø§ÛŒ Ø§ØªØµØ§Ù„!</h2><p class="text-gray-600 mt-2">Ø°Ø®ÛŒØ±Ù‡ Ø§Ù…ØªÛŒØ§Ø² Ø§Ù…Ú©Ø§Ù†â€ŒÙ¾Ø°ÛŒØ± Ù†ÛŒØ³Øª.</p>';
                         messageBox.style.display = 'flex';
                    }
                }
            });

        } catch (error) {
            console.error("Firebase Initialization Error:", error);
            loadingPrompt.innerHTML = '<h2 class="message-title text-4xl text-red-600">Ø®Ø·Ø§ÛŒ Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ!</h2><p class="text-gray-600 mt-2">Ø³ÛŒØ³ØªÙ… Ù†ØªÙˆØ§Ù†Ø³Øª Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø´ÙˆØ¯.</p>';
            messageBox.style.display = 'flex';
        }
    }


    // --- EVENT HANDLERS ---
    
    document.addEventListener('keydown', (e) => {
        // Jump action
        if (e.code === 'Space' && gameRunning && currentUserId) {
            e.preventDefault(); 
            player.jump();
        }
    });

    canvas.addEventListener('click', () => {
        if (gameRunning && currentUserId) {
            player.jump();
        }
    });

    // Sign out button is hidden, but if shown, it would sign out of anonymous session
    // signOutButton.addEventListener('click', signOutUser); 

    shopButton.addEventListener('click', openShop);
    closeShopButton.addEventListener('click', closeShop);
    restartButton.addEventListener('click', resetGame); 
    startPrompt.addEventListener('click', resetGame); 

    // Initial setup when window loads
    window.onload = function() {
        setupCanvas();
        initializeFirebase();
    };

    // --- PLAYER AND OBSTACLE CLASSES ---
    
    function setupCanvas() {
        canvas.width = CANVAS_WIDTH;
        canvas.height = CANVAS_HEIGHT;
    }

    const player = {
        x: 50, y: CANVAS_HEIGHT - CAT_HEIGHT, width: CAT_WIDTH, height: CAT_HEIGHT, vy: 0, isJumping: false,
        draw: function() { 
            const palette = CAT_PALETTES.find(p => p.id === currentCatId) || CAT_PALETTES[0];
            drawCat(ctx, this.x, this.y, this.width, this.height, palette);
        },
        update: function() {
            this.vy += GRAVITY;
            this.y += this.vy;
            const groundY = CANVAS_HEIGHT - this.height;
            if (this.y >= groundY) {
                this.y = groundY;
                this.vy = 0;
                this.isJumping = false;
            }
        },
        jump: function() {
            if (!this.isJumping) {
                this.vy = JUMP_VELOCITY;
                this.isJumping = true;
                playJumpSound();
            }
        }
    };

    class Obstacle {
        constructor(x) {
            this.x = x;
            this.width = EMOJI_SIZE * 1.5; 
            this.height = EMOJI_SIZE * 1.2; 
            this.y = CANVAS_HEIGHT - this.height;
        }
        draw() {
            drawBox(ctx, this.x, this.y, this.width, this.height);
        }
        update() {
            this.x -= OBSTACLE_SPEED; 
        }
    }

</script>

</body>
</html>
