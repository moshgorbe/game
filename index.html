<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بازي پرش گربه و موش</title>
    <!-- Tone.js for simple sound effects -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <!-- Tailwind CSS CDN for base styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700;900&display=swap');
        
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: #dbeafe; 
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        #game-container {
            background-color: #ffffff;
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3); 
            padding: 20px;
            width: 100%;
            max-width: 600px;
            text-align: center;
            position: relative; /* Needed for modals */
        }

        #game-canvas {
            display: block;
            /* رنگ پس‌زمينه کف زمين */
            background: linear-gradient(to bottom, #d6f2ff 0%, #d6f2ff 82%, #443021 82%, #443021 100%);
            border: 4px solid #333;
            border-radius: 10px;
            margin-top: 15px;
            box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.4); 
            touch-action: none; 
        }

        .game-ui {
            padding: 10px 0;
            display: flex;
            justify-content: space-between; 
            align-items: center;
        }

        #score-display {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e3a8a;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.15); 
        }
        
        #high-score-display, #coin-display { 
            font-size: 1.1rem;
            font-weight: 700;
            color: #ef4444; 
            border: 2px solid #fca5a5;
            padding: 4px 8px;
            border-radius: 5px;
            background-color: #fee2e2;
            display: inline-block;
            margin: 0 5px;
        }

        .btn {
            padding: 10px 20px;
            font-size: 1.2rem;
            font-weight: 700;
            color: white;
            background-color: #f97316; 
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s;
            box-shadow: 0 8px 25px rgba(249, 115, 22, 0.6); 
            margin-top: 10px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn:hover {
            background-color: #ea580c;
            transform: translateY(-4px); 
            box-shadow: 0 10px 30px rgba(249, 115, 22, 0.8);
        }

        .btn:active {
            transform: translateY(-1px);
        }

        /* Modal styling for all overlay boxes */
        .modal-box {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85); 
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }

        .modal-content {
            background-color: #fff;
            padding: 30px 40px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.8); 
            max-width: 90%;
            transform: scale(1);
            animation: pop-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            max-height: 80vh;
            overflow-y: auto;
        }
        
        /* Make shop modal larger for two-column layout */
        #shop-box .modal-content {
            max-width: 950px; 
            width: 95%; 
        }

        .message-title {
            font-size: 2.2rem;
            color: #f97316;
            margin-bottom: 10px;
        }

        .auth-input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 2px solid #ccc;
            border-radius: 8px;
            text-align: right;
            font-size: 1.1rem;
            transition: border-color 0.2s;
        }
        .auth-input:focus {
             border-color: #3b82f6;
             outline: none;
        }

        /* Admin specific styling */
        .admin-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            text-align: center;
            font-size: 1rem;
            transition: border-color 0.2s;
        }
        
        /* Shop Item Styling */
        .shop-item {
            border: 2px solid;
            padding: 15px;
            border-radius: 12px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .shop-item.selected {
            border-color: #3b82f6;
            background-color: #eff6ff;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
        }
        .shop-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

    </style>
</head>
<body>

<div id="game-container" class="relative">
    <h1 class="text-3xl font-bold text-gray-800 mb-2">پرش گربه: تعقيب و گريز موش ????</h1>
    
    <!-- User Status Bar -->
    <div id="user-status" class="flex justify-between items-center text-xs text-gray-600 mb-2 p-1 bg-gray-50 rounded-lg border border-gray-100" style="display: none;">
        <span id="user-info-text"></span>
        <button id="sign-out-button" class="bg-red-500 text-white px-2 py-1 rounded-md hover:bg-red-600 transition duration-150 text-xs">خروج</button>
    </div>

    <div class="game-ui">
        <div class="flex items-center">
            <div id="score-display">امتياز: 0</div>
        </div>
        <button id="shop-button" class="btn bg-blue-500 hover:bg-blue-600 shadow-blue-500/40 !text-sm !py-2 !px-4 !m-0">
            فروشگاه ???
        </button>
    </div>
    
    <div class="flex justify-center mb-2">
        <div id="high-score-display">بهترين: 0</div>
        <div id="coin-display">سکه گربه: 0 ??</div>
    </div>

    <canvas id="game-canvas"></canvas>

    <!-- 1. Authentication Modal -->
    <div id="auth-modal" class="modal-box" style="display: none;">
        <div class="modal-content !p-8 max-w-sm">
            <h2 class="message-title text-4xl mb-4">ورود / ثبت نام</h2>
            <p class="text-gray-600 mb-6">براي ذخيره پيشرفت خود، يک نام کاربري و رمز عبور دلخواه وارد کنيد.</p>
            
            <input type="text" id="auth-username" class="auth-input" placeholder="نام کاربري (ID دلخواه)">
            <input type="password" id="auth-password" class="auth-input" placeholder="رمز عبور (حداقل ? کاراکتر)">
            
            <!-- NEW: Confirm Password for Sign Up -->
            <input type="password" id="auth-confirm-password" class="auth-input hidden" placeholder="تکرار رمز عبور" style="margin-bottom: 25px;">

            <button id="login-button" class="btn w-full bg-indigo-600 hover:bg-indigo-700 shadow-indigo-500/40 mb-3">
                ورود به بازي
            </button>
            <button id="signup-button" class="btn w-full bg-green-600 hover:bg-green-700 shadow-green-500/40">
                ايجاد حساب و شروع بازي
            </button>
            <p id="auth-error" class="text-red-500 mt-3 hidden"></p>
        </div>
    </div>

    <!-- 2. Game Over / Start Message Box -->
    <div id="message-box" class="modal-box" style="display: none;">
        <div id="message-content" class="modal-content">
            <div id="start-prompt" class="cursor-pointer hover:scale-105 transform transition duration-200">
                <div class="text-[4rem] mb-2">??</div>
                <h2 class="message-title !text-4xl text-gray-800">آماده‌اي؟ بزن بريم!</h2>
            </div>

            <div id="game-over-details" style="display: none;">
                <!-- عنوان بازي تمام شد: اينجا جمله انگيزشي/طعنه‌آميز نمايش داده مي‌شود -->
                <h2 id="message-title" class="message-title">بازي تمام شد!</h2>
                <p id="message-text" class="message-text"></p>
                <!-- NEW: Sarcastic/Motivational message -->
                <p id="sarcastic-message" class="text-base text-gray-600 mt-3 italic font-medium"></p>
                <button id="restart-button" class="btn bg-green-500 hover:bg-green-600 shadow-green-500/40">شروع مجدد</button>
            </div>
        </div>
    </div>
    
    <!-- 3. Shop Modal Box -->
    <div id="shop-box" class="modal-box" style="display: none;">
        <div class="modal-content !p-5">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h2 class="text-3xl font-bold text-gray-800">فروشگاه گربه ???</h2>
                <button id="close-shop-button" class="text-gray-500 hover:text-gray-700 text-3xl font-light leading-none">
                    &times;
                </button>
            </div>
            
            <div class="mb-4">
                <div id="shop-coin-display" class="font-bold text-xl text-yellow-700 bg-yellow-100 p-2 rounded-lg">
                    سکه گربه شما: 0 ??
                </div>
                <p class="text-sm text-gray-500 mt-1">امتيازهاي کسب‌شده در بازي به سکه تبديل مي‌شوند (فقط با شکستن رکورد).</p>
            </div>
            
            <!-- Shop Sections Container: Flexbox for side-by-side columns -->
            <div class="flex flex-col lg:flex-row gap-6">

                <!-- SECTION 1: CAT PURCHASE (خريد گربه و پوسته‌ها) - Takes 2/3 width on large screens -->
                <div class="w-full lg:w-2/3 bg-indigo-50 p-5 rounded-xl border-t-4 border-indigo-500 shadow-md">
                    <h3 class="text-xl font-extrabold text-indigo-800 mb-4 border-b pb-2">
                        بخش ?: خريد گربه و پوسته‌ها ??
                    </h3>
                    <div id="shop-items-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Shop items will be rendered here -->
                    </div>
                </div>
                <!-- END SECTION 1 -->

                <!-- SECTION 2: COIN SALE (فروش سکه گربه) - Takes 1/3 width on large screens -->
                <div class="w-full lg:w-1/3 bg-yellow-100 p-5 rounded-xl border-t-4 border-yellow-500 shadow-md flex flex-col justify-between">
                    <div>
                        <h3 class="text-xl font-extrabold text-yellow-800 mb-3 border-b pb-2">
                            بخش ?: فروش سکه گربه ??
                        </h3>
                        <p class="text-gray-700 mb-4 text-sm leading-relaxed">
                            مي‌توانيد سکه‌هاي اضافي خود را بفروشيد! براي هماهنگي و تعيين قيمت، روي دکمه زير کليک کنيد تا به صورت مستقيم با ادمين در تلگرام ارتباط برقرار کنيد. آيدي کاربري شما براي تأييد حساب، <span id="tele-uid-display" class="font-mono text-xs font-semibold text-gray-900">...</span> است.
                        </p>
                    </div>
                    <!-- دکمه هدايت به تلگرام -->
                    <a id="telegram-link" href="https://t.me/moshgorbeadmin" target="_blank"
                       class="inline-flex items-center justify-center w-full bg-cyan-600 text-white py-2.5 px-6 rounded-lg font-black text-base transition duration-300 transform hover:bg-cyan-700 hover:scale-[1.02] shadow-lg focus:outline-none focus:ring-4 focus:ring-cyan-300 mt-4">
                        فروش سکه و تماس با ادمين
                        <!-- آيکون تلگرام (inline SVG for simplicity) -->
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M19.9 5.09a.57.57 0 00-.7-.1l-16.5 6.3a.57.57 0 00.08 1.05l4.6 1.48 10.33-6.57a.1.1 0 01.12.02l-8.52 7.72-.1 3.52c0 .24.18.44.42.48l1.7-.13c.12-.01.23-.08.28-.19l2.7-2.6 4.7 3.5a.57.57 0 00.4.15.58.58 0 00.37-.15.57.57 0 00.17-.46l1.3-8.8a.57.57 0 00-.36-.67z"/>
                        </svg>
                    </a>
                </div>
                <!-- END SECTION 2 -->
            </div>
            <!-- End Shop Sections Container -->

            <!-- Admin Access Link in Shop (NEW LOCATION) -->
            <div class="mt-6 pt-3 border-t border-gray-200 text-left">
                <a id="shop-admin-trigger" class="text-xs text-gray-400 hover:text-gray-600 cursor-pointer font-mono" title="Admin Access">
                    ?? Admin Console Access
                </a>
            </div>
        </div>
    </div>
    
    <!-- 4. Admin Modal Box -->
    <div id="admin-modal" class="modal-box" style="display: none;">
        <div class="modal-content !p-6 max-w-md">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h2 class="text-2xl font-bold text-gray-800">پنل مديريت امتياز ??</h2>
                <button id="close-admin-button" class="text-gray-500 hover:text-gray-700 text-3xl font-light leading-none">
                    &times;
                </button>
            </div>
            
            <!-- Admin Login -->
            <div id="admin-login-view" class="space-y-4">
                <p class="text-red-600 font-semibold text-sm">?? دسترسي فقط براي مدير مجاز است ??</p>
                <input type="text" id="admin-username-input" placeholder="نام کاربري مدير"
                       class="admin-input border-blue-300">
                <input type="password" id="admin-password-input" placeholder="رمز عبور محرمانه"
                       class="admin-input border-blue-300">
                <button id="admin-login-button"
                        class="btn w-full bg-indigo-600 hover:bg-indigo-700 shadow-indigo-500/40 !mt-5">
                    ورود به پنل
                </button>
                <p id="admin-login-message" class="text-center text-sm text-red-500 mt-2 hidden"></p>
            </div>
            
            <!-- Admin Panel -->
            <div id="admin-panel-view" class="space-y-5 hidden">
                <!-- Search -->
                <div class="p-3 border border-blue-300 bg-blue-50 rounded-lg space-y-2">
                    <h3 class="font-bold text-blue-700">جستجوي کاربر</h3>
                    <input type="text" id="admin-user-id-input" placeholder="آيدي دقيق کاربر (UID)"
                           class="admin-input text-gray-800">
                    <button id="admin-search-button"
                            class="btn w-full bg-blue-500 hover:bg-blue-600 !py-2 !px-4 !mt-0 !mb-1">
                        جستجو و مشاهده امتياز
                    </button>
                </div>
                
                <!-- Score Display -->
                <div id="admin-score-display" class="p-4 bg-gray-100 border border-gray-300 rounded-lg hidden">
                    <p class="text-gray-600 font-medium">امتياز جاري کاربر:</p>
                    <p class="text-3xl font-extrabold text-indigo-700 mt-1">
                        بهترين امتياز: <span id="admin-current-highscore">0</span> | سکه گربه: <span id="admin-current-catcoins">0</span> ??
                    </p>
                </div>

                <!-- Modify Score -->
                <div id="admin-modify-panel" class="p-3 border border-green-300 bg-green-50 rounded-lg space-y-2 hidden">
                    <h3 class="font-bold text-green-700">تغيير سکه گربه (Coins)</h3>
                    <input type="number" id="admin-point-amount-input" placeholder="مقدار سکه (مثال: 100)" value="100"
                           class="admin-input text-gray-800">
                    <div class="flex space-x-2 space-x-reverse">
                        <button id="admin-add-coins-button"
                                class="flex-1 bg-green-500 text-white p-2 rounded-lg font-bold hover:bg-green-600 transition duration-200">
                            افزودن (+)
                        </button>
                        <button id="admin-subtract-coins-button"
                                class="flex-1 bg-red-500 text-white p-2 rounded-lg font-bold hover:bg-red-600 transition duration-200">
                            کسر (-)
                        </button>
                    </div>
                </div>
                
                <p id="admin-operation-message" class="text-center text-sm mt-2 font-medium"></p>
            </div>
        </div>
    </div>
    
</div>

<script type="module">
    // --- FIREBASE IMPORTS ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

    // فعال کردن لاگ‌هاي Firebase براي ديباگ
    setLogLevel('Debug');
    
    // --- GLOBAL FIREBASE/AUTH VARIABLES ---
    let firebaseApp;
    let db;
    let auth;
    let currentUserId = null;
    let currentUsername = 'Guest'; 
    let isAuthReady = false; 
    let unsubscribeSnapshot = null; // To hold the Firestore listener unsubscriber
    
    // --- PERSISTENCE/FIRESTORE PATHS ---
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-game-app-id';
    const GAME_DATA_COLLECTION = 'gameData';
    const GAME_PROFILE_DOCUMENT = 'profile';
    const ADMIN_USER = "amirbinyaz"; // Hardcoded Admin Credential (secret)
    const ADMIN_PASS = "09178458526amirpc"; // Hardcoded Admin Credential (secret)

    // Utility to get the user-specific path
    function getUserDataPath(userId) {
        return `artifacts/${appId}/users/${userId}/${GAME_DATA_COLLECTION}/${GAME_PROFILE_DOCUMENT}`;
    }
    
    // --- GAME CONSTANTS ---
    const CANVAS_WIDTH = 560;
    const CANVAS_HEIGHT = 200;
    const GRAVITY = 0.6;
    const JUMP_VELOCITY = -12;
    const BASE_SPEED = 5; 
    const SPEED_INCREASE_RATE = 0.2; 
    let OBSTACLE_SPEED; 
    const MIN_OBSTACLE_INTERVAL = 900; 
    const MAX_OBSTACLE_INTERVAL = 2000; 
    const PARALLAX_SPEED_FACTOR = 0.2; 
    const EMOJI_SIZE = 35; // Base size used for scaling 
    const CAT_HEIGHT = EMOJI_SIZE * 1.1; 
    const CAT_WIDTH = EMOJI_SIZE * 1.6; 
    const DEFAULT_CAT_ID = 'tabby';

    const CAT_PALETTES = [
        { id: 'tabby', name: 'گربه تبي (پيش فرض)', price: 0, BODY_BASE: '#735f52', STRIPE_COLOR: '#52453a', BELLY_COLOR: '#e5e5e5', EYE_COLOR: '#44aa00', EAR_PINK: '#f0d0c0' },
        { id: 'black', name: 'گربه سياه', price: 100, BODY_BASE: '#111111', STRIPE_COLOR: '#000000', BELLY_COLOR: '#333333', EYE_COLOR: '#ffcc00', EAR_PINK: '#555555' },
        { id: 'white', name: 'گربه سفيد', price: 100, BODY_BASE: '#ffffff', STRIPE_COLOR: '#e0e0e0', BELLY_COLOR: '#f0f0f0', EYE_COLOR: '#0099ff', EAR_PINK: '#ffaaaa' },
        { id: 'ginger', name: 'گربه پرتقالي', price: 200, BODY_BASE: '#ff9933', STRIPE_COLOR: '#cc6600', BELLY_COLOR: '#fff0d0', EYE_COLOR: '#009900', EAR_PINK: '#ffccaa' },
    ];
    
    // جملات طعنه‌آميز براي نمايش بعد از باخت
    const SARCASTIC_MESSAGES = [
        "ناراحت نباشيد، گربه‌ها براي خوابيدن ساخته شدن نه پريدن! ??",
        "احتمالاً مقصر جاذبه‌ي زمين بوده، شما که عالي پريديد! ??",
        "فراموش نکنيد، موش‌ها خيلي سريع‌تر از اون چيزي هستن که فکر مي‌کنيد. شايد... ??",
        "يه روز ديگه براي تمرين کردن و نه امروز! ??",
        "مشکلي نيست، فقط لازم نيست براي هر چيزي که مي‌بينيد، بپريد! ??",
        "مهم اينه که تلاش کرديد! (بهتره دفعه بعد محکم‌تر بپريد) ??",
        "شايد بايد به جاي گربه، خرگوش انتخاب مي‌کرديد. ??",
        "عاليه! حداقل ديگه مجبور نيستيد با اون موش سر و کله بزنيد. استراحت کنيد! ??‍??"
    ];
    
    // جملات مربوط به باخت گربه
    const catLossPhrases = [
        "اوه سرم شکست! ??", "اين موش ارزش اين همه دردسر رو نداره! ??", "کف اين خونه خيلي ليزه! ??",
        "اخ! پاي من! ??", "لعنت به جعبه‌ها! ??", "فکر کنم ? تا جونم تموم شد! ??"
    ];

    // --- DOM Elements ---
    const canvas = document.getElementById('game-canvas');
    const ctx = canvas.getContext('2d');
    const scoreDisplay = document.getElementById('score-display');
    const highScoreDisplay = document.getElementById('high-score-display'); 
    const coinDisplay = document.getElementById('coin-display'); 
    const messageBox = document.getElementById('message-box');
    const startPrompt = document.getElementById('start-prompt');
    const gameOverDetails = document.getElementById('game-over-details');
    const messageTitle = document.getElementById('message-title'); 
    const messageText = document.getElementById('message-text'); 
    const sarcasticMessage = document.getElementById('sarcastic-message'); // NEW
    const restartButton = document.getElementById('restart-button'); 
    const shopButton = document.getElementById('shop-button');
    const shopBox = document.getElementById('shop-box'); 
    const closeShopButton = document.getElementById('close-shop-button');
    const shopItemsContainer = document.getElementById('shop-items-container');
    const shopCoinDisplay = document.getElementById('shop-coin-display');
    const authModal = document.getElementById('auth-modal');
    const authUsernameInput = document.getElementById('auth-username');
    const authPasswordInput = document.getElementById('auth-password');
    const authConfirmPasswordInput = document.getElementById('auth-confirm-password'); 
    const loginButton = document.getElementById('login-button');
    const signupButton = document.getElementById('signup-button');
    const authError = document.getElementById('auth-error');
    const signOutButton = document.getElementById('sign-out-button');
    const userStatus = document.getElementById('user-status');
    const userInfoText = document.getElementById('user-info-text');
    const teleUidDisplay = document.getElementById('tele-uid-display');
    
    // --- ADMIN DOM ELEMENTS ---
    const adminModal = document.getElementById('admin-modal');
    const closeAdminButton = document.getElementById('close-admin-button');
    const shopAdminTrigger = document.getElementById('shop-admin-trigger'); 
    const adminLoginView = document.getElementById('admin-login-view');
    const adminPanelView = document.getElementById('admin-panel-view');
    const adminUsernameInput = document.getElementById('admin-username-input');
    const adminPasswordInput = document.getElementById('admin-password-input');
    const adminLoginButton = document.getElementById('admin-login-button');
    const adminLoginMessage = document.getElementById('admin-login-message');
    const adminUserIdInput = document.getElementById('admin-user-id-input');
    const adminSearchButton = document.getElementById('admin-search-button');
    const adminScoreDisplay = document.getElementById('admin-score-display');
    const adminCurrentHighscore = document.getElementById('admin-current-highscore');
    const adminCurrentCatcoins = document.getElementById('admin-current-catcoins');
    const adminModifyPanel = document.getElementById('admin-modify-panel');
    const adminPointAmountInput = document.getElementById('admin-point-amount-input');
    const adminAddCoinsButton = document.getElementById('admin-add-coins-button');
    const adminSubtractCoinsButton = document.getElementById('admin-subtract-coins-button');
    const adminOperationMessage = document.getElementById('admin-operation-message');

    // --- Game Variables and State ---
    let gameRunning = false;
    let score = 0;
    let obstacles = [];
    let particles = []; 
    let nextObstacleTime = 0;
    let animationFrameId;
    let mousePositionX; 
    
    let highScore = 0; 
    let catCoins = 0; 
    let unlockedCats = [DEFAULT_CAT_ID]; 
    let currentCatId = DEFAULT_CAT_ID;
    let dataChanged = false; // Flag to check if save is needed
    
    let lastSearchedAdminUserId = null; // For Admin Panel state

    // --- UTILITIES & DRAWING FUNCTIONS (UNCHANGED) ---

    function drawCat(ctx, x, y, width, height, palette) {
        const p = palette; 
        const headSize = width * 0.55;
        const tailLength = width * 0.7;
        const tailThickness = width * 0.1;

        // 1. Tail (Behind body, drawn first)
        ctx.fillStyle = p.BODY_BASE;
        ctx.beginPath();
        ctx.moveTo(x + width * 0.1, y + height * 0.9);
        ctx.bezierCurveTo(x - tailLength * 0.5, y + height * 0.5,
                          x + width * 0.2, y + height * 0.2,
                          x + width * 0.8, y + headSize * 0.2); // Neck
        ctx.lineTo(x + width * 0.1, y + height * 0.9 + tailThickness); 
        ctx.closePath();
        ctx.fill();

        // 2. Body
        ctx.fillStyle = p.BODY_BASE;
        ctx.beginPath();
        // Main body shape (more curved, like a side view)
        ctx.moveTo(x + width * 0.1, y + height * 0.95); // Start at back foot
        ctx.bezierCurveTo(x + width * 0.1, y + height * 0.1, 
                          x + width * 0.6, y, 
                          x + width * 0.8, y + headSize * 0.2); // Neck
        ctx.lineTo(x + width * 0.8, y + height * 0.95); // Front leg area
        ctx.closePath();
        ctx.fill();
        
        // 3. Belly (Lighter color - simple ellipse on the lower half)
        ctx.fillStyle = p.BELLY_COLOR;
        ctx.beginPath();
        ctx.ellipse(x + width * 0.45, y + height * 0.8, width * 0.35, height * 0.15, 0, 0, Math.PI * 2);
        ctx.fill();

        // 4. Head
        ctx.fillStyle = p.BODY_BASE;
        ctx.beginPath();
        ctx.arc(x + width * 0.8, y + headSize * 0.6, headSize * 0.6, 0, Math.PI * 2);
        ctx.fill();

        // 5. Ears (Left ear)
        ctx.fillStyle = p.BODY_BASE;
        ctx.beginPath();
        ctx.moveTo(x + width * 0.65, y + headSize * 0.05); 
        ctx.lineTo(x + width * 0.8, y - height * 0.2); // Ear tip
        ctx.lineTo(x + width * 0.9, y + headSize * 0.2);
        ctx.fill();
        
        // Inner ear
        ctx.fillStyle = p.EAR_PINK;
        ctx.beginPath();
        ctx.moveTo(x + width * 0.7, y + headSize * 0.15);
        ctx.lineTo(x + width * 0.8, y - height * 0.1);
        ctx.lineTo(x + width * 0.88, y + headSize * 0.2);
        ctx.fill();

        // 6. Eye (Simple green/yellow circle)
        ctx.fillStyle = p.EYE_COLOR;
        ctx.beginPath();
        ctx.arc(x + width * 0.85, y + headSize * 0.5, headSize * 0.08, 0, Math.PI * 2);
        ctx.fill();
        
        // 7. Stripes/Details (Tabby/Ginger)
        if (p.id === 'tabby' || p.id === 'ginger') {
            ctx.strokeStyle = p.STRIPE_COLOR;
            ctx.lineWidth = 1.5;
            ctx.beginPath();
            // Body stripes
            ctx.moveTo(x + width * 0.25, y + height * 0.5);
            ctx.lineTo(x + width * 0.35, y + height * 0.7);
            ctx.moveTo(x + width * 0.45, y + height * 0.4);
            ctx.lineTo(x + width * 0.55, y + height * 0.6);
            ctx.stroke();
        }

        // 8. Simple Paws
        ctx.fillStyle = p.BODY_BASE;
        ctx.fillRect(x + width * 0.1, y + height - 5, width * 0.15, 5); // Back paw
        ctx.fillRect(x + width * 0.7, y + height - 5, width * 0.15, 5); // Front paw
    }

    function drawBox(ctx, x, y, width, height) {
        const depth = width * 0.2;
        const lidHeight = height * 0.05; 
        
        // Colors for cardboard effect
        const frontColor = '#B08968'; 
        const sideColor = '#9E7754';   
        const topColor = '#C6A98C';   
        const tapeColor = '#E3D5CA';   

        // Adjust Y to account for lid height when drawing the box itself
        const boxY = y + lidHeight;
        const boxHeight = height - lidHeight;

        // 1. Front Face (Largest surface)
        ctx.fillStyle = frontColor;
        ctx.fillRect(x, boxY, width, boxHeight); 
        
        // 2. Right Side Face (slanted for 3D effect)
        ctx.fillStyle = sideColor;
        ctx.beginPath();
        ctx.moveTo(x + width, boxY);
        ctx.lineTo(x + width + depth, boxY + depth * 0.5); 
        ctx.lineTo(x + width + depth, boxY + boxHeight + depth * 0.5); 
        ctx.lineTo(x + width, boxY + boxHeight);
        ctx.closePath();
        ctx.fill();

        // 3. Top Lid
        ctx.fillStyle = topColor;
        ctx.beginPath();
        ctx.moveTo(x, boxY); 
        ctx.lineTo(x + depth, boxY + depth * 0.5); 
        ctx.lineTo(x + width + depth, boxY + depth * 0.5); 
        ctx.lineTo(x + width, boxY); 
        ctx.closePath();
        ctx.fill();
        
        // 4. Sealing Tape (Across the middle of the lid)
        ctx.fillStyle = tapeColor;
        const tapeWidth = width * 0.8;
        const tapeHeight = 5;
        const tapeOffset = depth * 0.5; 
        
        // Draw tape on the front face (simulated projection)
        ctx.fillRect(x + width * 0.1, boxY, tapeWidth, tapeHeight);
        
        // Draw tape on the top face (angled)
        ctx.beginPath();
        ctx.moveTo(x + width * 0.1, boxY);
        ctx.lineTo(x + width * 0.1 + depth, boxY + tapeOffset);
        ctx.lineTo(x + width * 0.1 + depth + tapeWidth, boxY + tapeOffset);
        ctx.lineTo(x + width * 0.1 + tapeWidth, boxY);
        ctx.closePath();
        ctx.fill();
        
        // 5. Mouse icon (for context)
        ctx.fillStyle = '#222';
        ctx.font = '18px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('??', x + width / 2, boxY + boxHeight * 0.6);
    }
    
    // --- SOUNDS (Tone.js) ---
    const jumpSynth = new Tone.MembraneSynth().toDestination();
    const scoreSynth = new Tone.PolySynth(Tone.Synth).toDestination();
    const collisionSynth = new Tone.NoiseSynth({
        noise: { type: "white" },
        envelope: { attack: 0.005, decay: 0.1, sustain: 0, release: 0.1 }
    }).toDestination();
    const buySynth = new Tone.Synth({
        oscillator: { type: "sine" },
        envelope: { attack: 0.01, decay: 0.1, sustain: 0.05, release: 0.2 }
    }).toDestination();
    
    function playJumpSound() { jumpSynth.triggerAttackRelease("C4", "8n"); }
    function playScoreSound() { scoreSynth.triggerAttackRelease(["E5", "G5", "C6"], "16n"); }
    function playCollisionSound() { collisionSynth.triggerAttackRelease("8n"); }
    function playBuySound(success) { 
        if (success) {
             buySynth.triggerAttackRelease(["C5", "E5", "G5"], "8n"); 
        } else {
             buySynth.triggerAttackRelease("C3", "16n");
        }
    }


    // --- FIREBASE AUTHENTICATION LOGIC (UNCHANGED) ---

    function showAuthError(message) {
        authError.textContent = message;
        authError.classList.remove('hidden');
        setTimeout(() => authError.classList.add('hidden'), 5000);
    }
    
    function toggleConfirmPassword(show) {
        if (show) {
            authConfirmPasswordInput.classList.remove('hidden');
        } else {
            authConfirmPasswordInput.classList.add('hidden');
            authConfirmPasswordInput.value = ''; 
        }
    }

    async function handleSignInUp(isSignup) {
        toggleConfirmPassword(isSignup); 

        const email = authUsernameInput.value.trim();
        const password = authPasswordInput.value;
        const confirmPassword = authConfirmPasswordInput.value; 
        
        if (!email || !password) {
            showAuthError("لطفاً نام کاربري و رمز عبور را وارد کنيد.");
            return;
        }

        if (isSignup) {
            if (password.length < 6) {
                showAuthError("رمز عبور بايد حداقل ? کاراکتر باشد.");
                return;
            }
            if (password !== confirmPassword) {
                showAuthError("رمزهاي عبور با يکديگر مطابقت ندارند.");
                return;
            }
        }

        const firebaseEmail = email.includes('@') ? email : `${email}@game-moshgorbe.com`;

        try {
            if (isSignup) {
                await createUserWithEmailAndPassword(auth, firebaseEmail, password);
            } else {
                await signInWithEmailAndPassword(auth, firebaseEmail, password);
            }
        } catch (error) {
            let errorMessage = "خطا در برقراري ارتباط. لطفا بعدا تلاش کنيد.";
            if (error.code === 'auth/weak-password') {
                errorMessage = "رمز عبور ضعيف است. حداقل ? کاراکتر استفاده کنيد.";
            } else if (error.code === 'auth/email-already-in-use') {
                errorMessage = "اين نام کاربري قبلاً ثبت شده است. لطفاً وارد شويد.";
            } else if (error.code === 'auth/invalid-email') {
                errorMessage = "نام کاربري معتبر نيست. (فقط حروف و اعداد مجاز است)";
            } else if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                errorMessage = "نام کاربري يا رمز عبور اشتباه است.";
            }
            showAuthError(errorMessage);
            console.error("Auth Error:", error);
        }
    }

    async function signOutUser() {
        if (auth && currentUserId) {
            try {
                await saveUserData(); 
                await signOut(auth);
            } catch (error) {
                console.error("Error signing out:", error);
            }
        }
    }
    
    // --- FIRESTORE DATA LOGIC (UNCHANGED) ---

    function loadUserData() {
        if (!currentUserId) return;

        if (unsubscribeSnapshot) {
            unsubscribeSnapshot();
        }

        const userDocRef = doc(db, getUserDataPath(currentUserId));
        
        unsubscribeSnapshot = onSnapshot(userDocRef, (docSnapshot) => {
            if (docSnapshot.exists()) {
                const data = docSnapshot.data();
                
                highScore = data.highScore || 0;
                catCoins = data.catCoins || 0;
                try {
                    unlockedCats = JSON.parse(data.unlockedCatsJson || '[]');
                    if (unlockedCats.length === 0) {
                         unlockedCats = [DEFAULT_CAT_ID];
                    }
                } catch (e) {
                    console.error("Error parsing unlockedCats:", e);
                    unlockedCats = [DEFAULT_CAT_ID];
                }
                currentCatId = data.currentCatId || DEFAULT_CAT_ID;

                console.log("Game data loaded from Firestore.");
            } else {
                console.log("No profile found. Setting up new profile...");
                highScore = 0;
                catCoins = 0;
                unlockedCats = [DEFAULT_CAT_ID];
                currentCatId = DEFAULT_CAT_ID;
                saveUserData();
            }

            updateGameUI();
            
            authModal.style.display = 'none';
            messageBox.style.display = 'flex';
            
            gameOverDetails.style.display = 'none'; 
            startPrompt.style.display = 'block'; 
        }, (error) => {
            console.error("Error fetching Firestore data:", error);
        });
    }

    async function saveUserData() {
        if (!currentUserId || !auth.currentUser || auth.currentUser.isAnonymous) {
            console.warn("Cannot save data: User not authenticated.");
            return;
        }

        if (!dataChanged) {
            return; 
        }
        
        const dataToSave = {
            userId: currentUserId,
            username: currentUsername,
            highScore: highScore,
            catCoins: catCoins,
            unlockedCatsJson: JSON.stringify(unlockedCats), 
            currentCatId: currentCatId,
            lastUpdated: new Date().toISOString()
        };
        
        try {
            const userDocRef = doc(db, getUserDataPath(currentUserId));
            await setDoc(userDocRef, dataToSave, { merge: true });
            console.log("Game data saved to Firestore successfully.");
            dataChanged = false;
        } catch (error) {
            console.error("Error saving game data:", error);
        }
    }
    
    // --- UI UPDATES (UNCHANGED) ---

    function updateGameUI() {
        highScoreDisplay.textContent = `بهترين: ${highScore}`;
        coinDisplay.textContent = `سکه گربه: ${catCoins} ??`;
        
        // Update Shop UI if open
        if (shopBox.style.display === 'flex') {
            shopCoinDisplay.textContent = `سکه گربه شما: ${catCoins} ??`;
            renderShopItems();
        }

        // Update User Status Bar
        if (currentUserId && !auth.currentUser.isAnonymous) {
            userStatus.style.display = 'flex';
            userInfoText.textContent = `کاربر: ${currentUsername} | آيدي: ${currentUserId}`;
            teleUidDisplay.textContent = currentUserId;
        } else {
            userStatus.style.display = 'none';
            teleUidDisplay.textContent = '(براي نمايش آيدي وارد شويد)';
        }
    }


    // --- GAME LOGIC FUNCTIONS ---

    function resetGame() {
        if (!currentUserId || auth.currentUser.isAnonymous) {
             authModal.style.display = 'flex';
             return;
        }

        gameRunning = true;
        score = 0;
        obstacles = [];
        particles = [];
        OBSTACLE_SPEED = BASE_SPEED; 
        mousePositionX = CANVAS_WIDTH * 2 + 500;
        nextObstacleTime = performance.now() + 1500; 
        
        player.y = CANVAS_HEIGHT - player.height;
        player.vy = 0;
        player.isJumping = false;
        
        scoreDisplay.textContent = 'امتياز: 0';
        messageBox.style.display = 'none';
        shopBox.style.display = 'none'; 
        adminModal.style.display = 'none'; // Ensure admin modal is closed
        
        gameOverDetails.style.display = 'none'; 
        startPrompt.style.display = 'block'; 
        
        if (animationFrameId) {
            cancelAnimationFrame(animationFrameId);
        }
        gameLoop();
    }

    function gameOver(isWin = false) { 
        gameRunning = false;
        cancelAnimationFrame(animationFrameId);
        
        const previousHighScore = highScore; 
        let coinsEarned = 0;
        let messageSuffix = '';

        if (score > previousHighScore) {
            highScore = score; 
            coinsEarned = score; 
            messageSuffix = `+${coinsEarned} سکه گربه (رکورد جديد!) کسب کرديد! ??`;
            dataChanged = true; 
        } else {
            coinsEarned = 0;
            messageSuffix = `سکه جديدي کسب نکرديد. بايد رکورد ${previousHighScore} را بشکنيد. ??`;
        }
        
        catCoins += coinsEarned;
        if (coinsEarned > 0) dataChanged = true;

        playCollisionSound(); 

        startPrompt.style.display = 'none';
        gameOverDetails.style.display = 'block'; 
        
        if (isWin) {
            messageTitle.textContent = 'شکار موفق! موش دستگير شد! ??';
            messageText.innerHTML = `شما پس از ${score} پرش موفق، برنده شديد! ??<br>${messageSuffix}`;
            sarcasticMessage.textContent = ''; // Clear sarcastic message on win
            restartButton.textContent = 'بازي مجدد';
        } else {
            const randomIndexTitle = Math.floor(Math.random() * catLossPhrases.length);
            const randomIndexSarcastic = Math.floor(Math.random() * SARCASTIC_MESSAGES.length);
            
            messageTitle.textContent = catLossPhrases[randomIndexTitle]; 
            messageText.innerHTML = `امتياز نهايي شما: ${score}<br>${messageSuffix}`;
            
            // نمايش جمله انگيزشي/طعنه‌آميز
            sarcasticMessage.textContent = SARCASTIC_MESSAGES[randomIndexSarcastic]; 
            
            restartButton.textContent = 'شروع مجدد';
        }
        
        messageBox.style.display = 'flex';
        
        saveUserData();
    }
    
    function checkCollision() {
        for (const obs of obstacles) {
            if (
                // hitbox is slightly smaller than the drawn box for forgiveness
                player.x + player.width * 0.9 > obs.x && 
                player.x + player.width * 0.2 < obs.x + obs.width + 10 && 
                player.y + player.height > obs.y + obs.height * 0.1 
            ) {
                return true; 
            }
        }
        return false;
    }

    function spawnObstacle(timestamp) {
        if (timestamp > nextObstacleTime) {
            obstacles.push(new Obstacle(CANVAS_WIDTH));
            const interval = MIN_OBSTACLE_INTERVAL + Math.random() * (MAX_OBSTACLE_INTERVAL - MIN_OBSTACLE_INTERVAL);
            nextObstacleTime = timestamp + interval;
        }
    }

    function drawMouse(ctx, x, y) {
        // Simple representation of the mouse (The target)
        ctx.fillStyle = '#6b7280';
        ctx.beginPath();
        ctx.arc(x, y, 10, 0, Math.PI * 2);
        ctx.fill();
        ctx.font = '16px Vazirmatn';
        ctx.fillStyle = '#111';
        ctx.textAlign = 'center';
        ctx.fillText('??', x, y + 5);
    }

    function updateGame(timestamp) {
        ctx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT); 

        // Draw Sky (handled by CSS background, but we can draw a simple ground line)
        // Draw the dark ground line
        ctx.fillStyle = '#443021';
        ctx.fillRect(0, CANVAS_HEIGHT - 5, CANVAS_WIDTH, 5);


        // Draw the mouse (target)
        drawMouse(ctx, mousePositionX, CANVAS_HEIGHT - 20);

        player.update();
        player.draw();
        
        spawnObstacle(timestamp);
        
        for (let i = 0; i < obstacles.length; i++) {
            const obs = obstacles[i];
            obs.update();
            obs.draw();

            if (obs.x + obs.width + 10 < 0) {
                score++;
                playScoreSound(); 
                OBSTACLE_SPEED += SPEED_INCREASE_RATE; 
                mousePositionX -= 2.04; 
                obstacles.splice(i, 1);
                i--; 
            }
        }
        
        if (checkCollision()) {
            gameOver(); 
            return;
        }

        if (mousePositionX <= 100) { 
             gameOver(true); 
             return;
        }

        scoreDisplay.textContent = 'امتياز: ' + score;
        animationFrameId = requestAnimationFrame(gameLoop);
    }
    
    function gameLoop(timestamp) {
        if (gameRunning && currentUserId && !auth.currentUser.isAnonymous) {
            updateGame(timestamp);
        } else if (gameRunning && auth.currentUser.isAnonymous) {
             gameOver(); 
             authModal.style.display = 'flex';
        }
    }


    // --- SHOP LOGIC (UNCHANGED JS) ---
    function openShop() {
        gameRunning = false; 
        if (animationFrameId) cancelAnimationFrame(animationFrameId);
        messageBox.style.display = 'none';
        adminModal.style.display = 'none';
        shopBox.style.display = 'flex';
        renderShopItems();
    }

    function closeShop() {
        shopBox.style.display = 'none';
        
        // Show the correct modal after closing shop
        if (currentUserId && !auth.currentUser.isAnonymous) {
            messageBox.style.display = 'flex';
            if (score > 0) {
                 startPrompt.style.display = 'none';
                 gameOverDetails.style.display = 'block';
            } else {
                 startPrompt.style.display = 'block';
                 gameOverDetails.style.display = 'none';
            }
        } else {
             authModal.style.display = 'flex';
        }
        
        if (dataChanged) saveUserData();
    }
    
    function buyCat(catId) {
        const cat = CAT_PALETTES.find(p => p.id === catId);
        if (!cat || cat.price === 0 || unlockedCats.includes(catId)) return;

        if (catCoins >= cat.price) {
            catCoins -= cat.price;
            unlockedCats.push(catId);
            currentCatId = catId; 
            dataChanged = true; 
            renderShopItems();
            playBuySound(true);
        } else {
            playBuySound(false);
        }
    }

    function selectCat(catId) {
        if (unlockedCats.includes(catId)) {
            currentCatId = catId;
            dataChanged = true; 
            renderShopItems(); 
        }
    }
    
    function renderShopItems() {
        shopCoinDisplay.textContent = `سکه گربه شما: ${catCoins} ??`;
        shopItemsContainer.innerHTML = '';

        CAT_PALETTES.forEach(cat => {
            const isUnlocked = unlockedCats.includes(cat.id);
            const isSelected = cat.id === currentCatId;
            const isFree = cat.price === 0;

            let buttonHTML = '';
            let itemClass = 'shop-item border-gray-300';

            if (isSelected) {
                buttonHTML = `<button class="btn bg-gray-500 !py-2 !px-4 !m-0 !mt-2">انتخاب شده ?</button>`;
                itemClass = 'shop-item selected';
            } else if (isUnlocked) {
                buttonHTML = `<button onclick="selectCat('${cat.id}')" class="btn bg-green-500 hover:bg-green-600 !py-2 !px-4 !m-0 !mt-2">انتخاب</button>`;
            } else if (isFree) {
                 buttonHTML = `<button onclick="buyCat('${cat.id}')" class="btn bg-green-500 hover:bg-green-600 !py-2 !px-4 !m-0 !mt-2">دريافت رايگان</button>`;
            } else {
                buttonHTML = `<button onclick="buyCat('${cat.id}')" class="btn bg-yellow-500 hover:bg-yellow-600 !py-2 !px-4 !m-0 !mt-2">${cat.price} ?? خريد</button>`;
                itemClass = 'shop-item border-gray-500'; // Removed 'locked' as it only controls styling
            }
            
            // Preview Cat (Simple emoji placeholder in the shop UI)
            const catEmoji = cat.id === 'black' ? '??‍?' : cat.id === 'white' ? '??' : cat.id === 'ginger' ? '??' : '??';

            const itemHTML = `
                <div class="${itemClass} flex flex-col items-center">
                    <div style="font-size: 3rem; line-height: 1;">${catEmoji}</div>
                    <h3 class="font-bold text-lg mt-2">${cat.name}</h3>
                    ${isUnlocked && !isSelected ? `<p class="text-sm text-gray-500">پوسته آزاد است</p>` : isFree ? `<p class="text-sm text-green-600">رايگان</p>` : `<p class="text-sm text-yellow-700">${cat.price} سکه</p>`}
                    ${buttonHTML}
                </div>
            `;
            shopItemsContainer.insertAdjacentHTML('beforeend', itemHTML);
        });
    }

    // --- ADMIN PANEL LOGIC (UNCHANGED JS) ---
    
    function showAdminMessage(element, message, type) {
        element.textContent = message;
        element.className = `text-center text-sm mt-2 font-medium ${type === 'error' ? 'text-red-600' : 'text-green-600'}`;
        element.classList.remove('hidden');
    }
    
    function openAdminModal() {
        // Close Shop and open Admin
        shopBox.style.display = 'none'; 
        gameRunning = false; 
        if (animationFrameId) cancelAnimationFrame(animationFrameId);
        messageBox.style.display = 'none';

        adminModal.style.display = 'flex';
        
        // Reset admin view to login state initially
        adminPanelView.classList.add('hidden');
        adminLoginView.classList.remove('hidden');
        adminLoginMessage.classList.add('hidden');
        adminUserIdInput.value = '';
        adminScoreDisplay.classList.add('hidden');
        adminModifyPanel.classList.add('hidden');
        lastSearchedAdminUserId = null;
        adminUsernameInput.value = '';
        adminPasswordInput.value = '';
        adminOperationMessage.classList.add('hidden');
    }
    
    function closeAdminModal() {
        adminModal.style.display = 'none';
        
        // Return to the shop modal after closing the admin panel
        openShop();
    }
    
    // Admin Login Handler
    adminLoginButton.addEventListener('click', () => {
        const username = adminUsernameInput.value.trim();
        const password = adminPasswordInput.value.trim();
        
        if (username === ADMIN_USER && password === ADMIN_PASS) {
            adminLoginView.classList.add('hidden');
            adminPanelView.classList.remove('hidden');
            showAdminMessage(adminOperationMessage, 'ورود موفقيت‌آميز. مي‌توانيد امتيازات را مديريت کنيد.', 'success');
        } else {
            showAdminMessage(adminLoginMessage, 'نام کاربري يا رمز عبور اشتباه است.', 'error');
        }
    });

    // Admin Search Handler
    adminSearchButton.addEventListener('click', async () => {
        const userId = adminUserIdInput.value.trim();
        if (!userId) {
            showAdminMessage(adminOperationMessage, 'لطفاً ID کاربر را وارد کنيد.', 'error');
            adminScoreDisplay.classList.add('hidden');
            adminModifyPanel.classList.add('hidden');
            return;
        }

        showAdminMessage(adminOperationMessage, 'در حال جستجو...', 'success');
        lastSearchedAdminUserId = userId;
        
        try {
            const userDocRef = doc(db, getUserDataPath(userId));
            const docSnap = await getDoc(userDocRef);

            let highscore = 0;
            let coins = 0;
            
            if (docSnap.exists()) {
                const data = docSnap.data();
                highscore = data.highScore || 0;
                coins = data.catCoins || 0;
                showAdminMessage(adminOperationMessage, `امتياز کاربر ${userId} پيدا شد.`, 'success');
            } else {
                showAdminMessage(adminOperationMessage, `کاربر ${userId} هنوز پروفايلي نساخته است. امتياز اوليه 0 در نظر گرفته شد.`, 'success');
            }
            
            adminCurrentHighscore.textContent = highscore;
            adminCurrentCatcoins.textContent = coins;
            adminScoreDisplay.classList.remove('hidden');
            adminModifyPanel.classList.remove('hidden');

        } catch (error) {
            console.error("Admin Search Error:", error);
            showAdminMessage(adminOperationMessage, `خطا در ارتباط با پايگاه داده: ${error.message}`, 'error');
            adminScoreDisplay.classList.add('hidden');
            adminModifyPanel.classList.add('hidden');
        }
    });
    
    // Admin Modify Handler
    async function modifyUserCoins(operation) {
        if (!lastSearchedAdminUserId) {
            showAdminMessage(adminOperationMessage, 'ابتدا يک کاربر را جستجو کنيد.', 'error');
            return;
        }
        
        const amount = parseInt(adminPointAmountInput.value, 10);
        if (isNaN(amount) || amount <= 0) {
            showAdminMessage(adminOperationMessage, 'مقدار سکه وارد شده معتبر نيست.', 'error');
            return;
        }

        // Check if admin is logged in (optional, but good practice if user could potentially manipulate this)
        if (adminPanelView.classList.contains('hidden')) {
             showAdminMessage(adminOperationMessage, 'لطفاً ابتدا وارد پنل مديريت شويد.', 'error');
             return;
        }


        const isAdding = operation === 'add';
        const multiplier = isAdding ? 1 : -1;
        
        try {
            showAdminMessage(adminOperationMessage, isAdding ? 'در حال افزودن سکه...' : 'در حال کسر سکه...', 'success');

            const userDocRef = doc(db, getUserDataPath(lastSearchedAdminUserId));
            
            // Get current value
            const docSnap = await getDoc(userDocRef);
            const currentCoins = docSnap.exists() ? (docSnap.data().catCoins || 0) : 0;
            const newCoins = Math.max(0, currentCoins + (amount * multiplier)); // Ensure coins don't go below zero

            await setDoc(userDocRef, { catCoins: newCoins }, { merge: true });

            adminCurrentCatcoins.textContent = newCoins;
            showAdminMessage(adminOperationMessage, `${amount} سکه ${isAdding ? 'اضافه' : 'کسر'} شد. سکه جديد: ${newCoins} ??`, 'success');
            
            // If the admin modified their own account, update the game's state immediately
            if (lastSearchedAdminUserId === currentUserId) {
                catCoins = newCoins;
                updateGameUI();
            }

        } catch (error) {
            console.error("Admin Modify Error:", error);
            showAdminMessage(adminOperationMessage, `خطا در به‌روزرساني سکه: ${error.message}`, 'error');
        }
    }
    
    adminAddCoinsButton.addEventListener('click', () => modifyUserCoins('add'));
    adminSubtractCoinsButton.addEventListener('click', () => modifyUserCoins('subtract'));
    closeAdminButton.addEventListener('click', closeAdminModal);
    
    // Admin Trigger inside Shop
    shopAdminTrigger.addEventListener('click', openAdminModal);


    // --- INITIALIZATION ---
    
    function initializeFirebase() {
        try {
            const firebaseConfig = JSON.parse(__firebase_config);
            firebaseApp = initializeApp(firebaseConfig);
            auth = getAuth(firebaseApp);
            db = getFirestore(firebaseApp);
            
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUserId = user.uid;
                    currentUsername = user.email ? user.email.split('@')[0] : `User_${user.uid.substring(0, 4)}`;
                    
                    if (user.isAnonymous) {
                         authModal.style.display = 'flex';
                         messageBox.style.display = 'none';
                         console.log("Signed in anonymously. Showing registration prompt.");
                         return;
                    }
                    
                    loadUserData(); 
                    console.log(`User ${currentUserId} logged in.`);
                } else {
                    currentUserId = null;
                    currentUsername = 'Guest';

                    try {
                        const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                        if (token) {
                            await signInWithCustomToken(auth, token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                         console.error("Error with initial/anonymous sign-in:", error);
                    }
                }
            });

        } catch (error) {
            console.error("Firebase Initialization Error:", error);
            authModal.style.display = 'flex';
        }
    }


    // --- EVENT HANDLERS (UNCHANGED) ---
    
    document.addEventListener('keydown', (e) => {
        // Jump action
        if (e.code === 'Space' && gameRunning && !auth.currentUser.isAnonymous) {
            e.preventDefault(); 
            player.jump();
        }
    });

    canvas.addEventListener('click', () => {
        if (gameRunning && !auth.currentUser.isAnonymous) {
            player.jump();
        }
    });

    loginButton.addEventListener('click', () => handleSignInUp(false));
    signupButton.addEventListener('click', () => handleSignInUp(true));

    loginButton.addEventListener('click', () => toggleConfirmPassword(false));
    signupButton.addEventListener('click', () => toggleConfirmPassword(true));
    authUsernameInput.addEventListener('focus', () => toggleConfirmPassword(false));
    authPasswordInput.addEventListener('focus', () => toggleConfirmPassword(false));

    signOutButton.addEventListener('click', signOutUser);

    shopButton.addEventListener('click', openShop);
    closeShopButton.addEventListener('click', closeShop);
    restartButton.addEventListener('click', resetGame); 
    startPrompt.addEventListener('click', resetGame); 

    // Initial setup when window loads
    window.onload = function() {
        setupCanvas();
        initializeFirebase();
    };

    // --- PLAYER AND OBSTACLE CLASSES (UNCHANGED) ---
    
    function setupCanvas() {
        canvas.width = CANVAS_WIDTH;
        canvas.height = CANVAS_HEIGHT;
    }

    const player = {
        x: 50, y: CANVAS_HEIGHT - CAT_HEIGHT, width: CAT_WIDTH, height: CAT_HEIGHT, vy: 0, isJumping: false,
        draw: function() { 
            const palette = CAT_PALETTES.find(p => p.id === currentCatId) || CAT_PALETTES[0];
            drawCat(ctx, this.x, this.y, this.width, this.height, palette);
        },
        update: function() {
            this.vy += GRAVITY;
            this.y += this.vy;
            const groundY = CANVAS_HEIGHT - this.height;
            if (this.y >= groundY) {
                this.y = groundY;
                this.vy = 0;
                this.isJumping = false;
            }
        },
        jump: function() {
            if (!this.isJumping) {
                this.vy = JUMP_VELOCITY;
                this.isJumping = true;
                playJumpSound();
            }
        }
    };

    class Obstacle {
        constructor(x) {
            this.x = x;
            this.width = EMOJI_SIZE * 1.5; 
            this.height = EMOJI_SIZE * 1.2; 
            this.y = CANVAS_HEIGHT - this.height;
        }
        draw() {
            drawBox(ctx, this.x, this.y, this.width, this.height);
        }
        update() {
            this.x -= OBSTACLE_SPEED; 
        }
    }

</script>

</body>
</html>
